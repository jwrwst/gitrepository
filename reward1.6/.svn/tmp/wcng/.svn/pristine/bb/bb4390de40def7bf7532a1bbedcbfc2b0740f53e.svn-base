<!DOCTYPE html>
<html>
	  <head>
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	    <title>众赏</title>
	    <link href="${basepath}/assets/plugin/mui/dist/css/mui.min.css" rel="stylesheet"/>
	    <link href="${basepath}/assets/def/css/tips.css" rel="stylesheet"/>
	    <link rel="shortcut icon" href="${basepath}/assets/favicon.ico" />
	    <style type="text/css">
	    	.rewardmoney{
	    	   width:60px!important;
	    	   height:30px!important;
	    	   border:1px solid #ccc!important;
	    	   text-align: center;
	    	   padding:0!important;
	    	   margin:10px;
	    	}
	    </style>
	  </head>
	  
	  <body> 	  	
	    <!--页面主结构开始-->
		<div id="center" class="mui-views">
			<div class="mui-view">	
			    <div class="mui-navbar">
				</div>	
				<div class="mui-pages">
				</div>
			</div>
		</div>	
	     
		<div id="regpage" class="mui-page" >
		  <!--页面标题栏开始-->
		  <div class="mui-navbar-inner mui-bar mui-bar-nav">				
				<h1 class="mui-center mui-title">赏金分配管理</h1>
				<a id="info" class="mui-icon mui-icon-help-filled mui-pull-right" style="color: #999;position: absolute;right: 5px;"></a>
		  </div>
		  <div class="mui-page-content" id="scroll-content">
		      <div class="scroller">
		  
		  		<div class="plat-content">		
		  		<a href="#resultpage" id="rega" style="display:none;"></a>  		
			     <form name = "storeInfo" id="storeInfo">
					<div class="mui-input-group">
						<div class="mui-input-row">
							<label>默认打赏金额</label>
							<span class="pull-right" style="right:0px;top:10px;font-size:12px !important;">元</span>
							<input type="text"  class="money iseditVal1" placeholder="" name="rewardMoney" id="rewardMoney" style="padding-right:20px;">
						</div>
						<div class="mui-input-row">
							<label>祝福语</label>
							<input type="text"  class="iseditVal1" placeholder="" name="wish" style="padding-right:20px;">
						</div>	
						<div class="mui-input-row">
							<label>顾客不可修改</label>
							<div class="mui-switch mui-active iseditVal1-switch" id="isUpdate">
								<div class="mui-switch-handle"></div>
								<input type="hidden" name="isUpdate">
							</div>
							<input type="text"  class="iseditVal1-checked" placeholder="" style="padding-right:20px;display:none;" readonly="readonly">
						</div>						
						<div class="mui-input-row">
								<label id="System.store.type">分配方案</label>
								<span class="mui-icon iconfont icon-up" style="right:0px;font-size:12px !important;"></span>								
								<select class="mui-btn mui-btn-block iseditVal1-sel" style="width:60%;background: transparent;padding-right:20px;text-align: center;" name="allotPlan" id="alotType">									
								</select>								
						</div>
						<div class="mui-input-row allotdis allot1002 allot1003" style="display:none;">
								<label id="System.store.type">职位</label>
								<input type="text"  class="iseditVal1" placeholder="请输入被分成人的职位信息，如：店长" name="extRewardlist.remark"   value="" style="padding-right:20px;">	
								<input type="hidden" name="extRewardlist.id" value="">
								<input type="hidden" name="extRewardlist.parentId" value="">									
						</div>	
						<div class="mui-input-row allotdis allot1002 allot1003" style="display:none;">
								<label id="System.store.type">分配账号</label>
								<span class="mui-icon iconfont icon-up" style="right:0px;font-size:12px !important;"></span>								
								<select class="mui-btn mui-btn-block iseditVal2-sel" style="width:50%;background: transparent;padding-right:20px;text-align: center;" name="extRewardlist.empId" id="managerList">									
								</select>								
						</div>
						<div class="mui-input-row allotdis allot1003 " style="display:none;">
							<label>店长分成比例</label>
							<div class="calc" style="text-align: right;height:40px;line-height: 40px;padding-right:10px;">
								<input type="text" placeholder="0" name="extRewardlist.money" class="money rewardmoney num iseditVal1" value="0">
								<span>≈</span>
								<input type="text" placeholder="0" name="extRewardlist.percent"  class="money rewardmoney percent iseditVal1"  value="0">
								<span>%</span>
							</div>
						</div>														
					</div>

					<!-- 分配人员 -->
					<div id="template-allot-content" class="allotdis allot1003">
						
					</div>
					<div class="plat-subtitle allotdis allot1003" style="display:none;">
						<a class="mui-icon mui-icon-plus iseditVal1-display"  style="float: right;" id="add"></a>
					</div>
					
					<div>
						<div class="mui-content-padded tips-reginfo-submit" >
						    <input type="hidden" name="storeId" id="storeId" value="">	
						    <input type="hidden" name="updateUser" id="updateUser" value="">						           
					        <button type="button" class="mui-btn mui-btn-warning mui-btn-block" id="regbnt">保存修改</button>					        	     
					    </div>
					      
					</div>
			
	
				</form>
				</div>
				
			  </div>	
           </div>
		</div>
		
		
		<div id="helppage" class="mui-page" >
		  <!--页面标题栏开始-->
		  <div class="mui-navbar-inner mui-bar mui-bar-nav">
		  	  <span class="mui-pull-left">		           						
  				<button class="mui-action-back mui-btn mui-btn-link mui-btn-nav mui-pull-left" style="color:#000000"><span class="mui-icon mui-icon-left-nav" style="color:#ff4e00"></span>返回赏金分配管理</button>	
		      </span>
		  </div>
		  <div class="mui-page-content" id="scroll-content-details">
		      <div class="scroller">
		  		<div class="plat-content">		  			 
			  		 <div style="padding:10px;font-size:15px;">
			  		 	<div style="font-weight:bold;font-size:15px;">如何分配打赏金额?</div>
			  		 	<div>众赏支持多种打赏金额分配方案</div>
			  		 	<div>
			  		 		<ul>
			  		 			<li>选择“全额分配给店员”，顾客打赏的金额将直接进入店员个人账户，店员随时可以全额提现。</li>
			  		 			<li>选择“统一账号代收”，顾客打赏的金额将进入到设置好的代收账户，通过线下方式发放给店员，便于店里统一管理。</li>
			  		 			<li>选择“店长、店员按比例分成”，顾客打赏的金额将按照预设，店员随时可的比例支付给店长和店员。</li>
			  		 		</ul>
			  		 	</div>
			  		 </div>			    
				</div>		
              </div>
           </div>
		</div>
		
		[#include '../model/menu.html']
	  </body>
	  <script src="${basepath}/assets/plugin/require.js"></script>
	  <script type="text/javascript" src="${basepath}/assets/def/js/tips/tips.js"></script>
	  <script type="text/template" id="template-allot">
                    {{#vo}}
                        <div class="plat-subtitle">
							<a class="mui-icon mui-icon-minus iseditVal1-display"  style="float: right;color:red;"></a>
						</div>
						<!-- 分配人员 -->
						<div class="mui-input-group removediv">
                            <div class="mui-input-row">
									<label id="System.store.type">职位</label>
									<input type="text"  class="iseditVal1" placeholder="请输入被分成人的职位信息，如：店长" name="extRewardlist.remark"   value="{{remark}}" style="padding-right:20px;">	
									<input type="hidden" name="extRewardlist.id" value="{{id}}">
									<input type="hidden" name="extRewardlist.parentId" value="{{parentId}}">				
							</div>

							<div class="mui-input-row">
									<label id="System.store.type">分配账号</label>
									<span class="mui-icon iconfont icon-up" style="right:0px;font-size:12px !important;"></span>								
									<select class="mui-btn mui-btn-block iseditVal2-sel" style="width:50%;background: transparent;padding-right:20px;text-align: center;" name="extRewardlist.empId">
                                     <option value=''>请选择分成人员</option>									
									 {{#each data}}
										{{if_def ../eid this}}
									 {{/each}}
									</select>								
							</div>
							<div class="mui-input-row">
								<label>店长分成比例</label>
								<div  class="calc" style="text-align: right;height:40px;line-height: 40px;padding-right:10px;">
								 <input type="text" placeholder="0" name="extRewardlist.money" class="money rewardmoney num iseditVal1" value={{money}}>
								 <span>≈</span>
								 <input type="text" placeholder="0" name="extRewardlist.percent"  class="money rewardmoney rate iseditVal1" value={{percent}}>
								 <span>%</span>
							    </div>
							</div>						
						</div>
                    {{/vo}}
	  </script>
	  
	 <script type="text/javascript">
  	  require(["template7"],function(template7){	  
		  //打赏纪录日期分组
		  Template7.registerHelper('if_def', function (val, options){	
			  if(val == options.empId ){
				 return "<option value='"+options.empId+"' selected='selected'>"+(options.empName||options.empNickName)+"("+options.jobTitle+")"+"</option>";
			  }else{
				 return "<option value='"+options.empId+"'>"+(options.empName||options.empNickName)+"("+options.jobTitle+")"+"</option>";
			  }

			});
  	  });
  	  </script> 
	  
	  <script type="text/javascript">
	  require(["jquery","mui","mui_view","addr","common","template7"],function($$,M,mui_view,addr,tools){
		  var storeId = window.localStorage.getItem("storeId");
		  var empId = window.localStorage.getItem("empId");
		  $$("#storeId").val(storeId);
		  $$("#updateUser").val(empId);
		  //初始化单页view
		  var viewApi = mui('#center').view({
		  	defaultPage: '#regpage'
		  });
		  
		  var empData={"vo":{"data":[],"eid":"0","money":"0","percent":"0"}};
		  $$(document).ready(function(){			  
			  
			  document.getElementById("isUpdate").addEventListener('toggle', function(event) {
					//event.detail.isActive 可直接获取当前状态
					$$("input[name='isUpdate']").val(event.detail.isActive ? '2' : '1');
		  	  });
			  
			  $$("#alotType").on("change",function(){
				  $$(".allotdis").hide();
				  if(this.value != "" && this.value != null){
					  $$("."+this.value).show();
				  }				  
			  });
			  			  
			  
			  //获取商户的分配方案
			  var merchantsReward = function(){
				  addr.getMechantsRewards("orgCode="+tools.global.merchants.orgCode,function(resData){

					  if(resData!=null && resData.resultMessage.messageCode =='0000' &&resData.resultData!=null){
						      var json = resData.resultData.body.result;							 
							  
							  var allotArr=resData.resultData.body.result;
							  //设置奖金分类
							  addr.getClassType("codeClass=System.allot.type", function(data){
								  var allot = allotArr[0];
								  if(data&&data.resultMessage.messageCode=="0000"){
									  var list = data.resultData.body.result;
									  var strHtml=[];
									  for(var i=0;i<list.length;i++){
										  if(allot&&allot.allotPlan==list[i].value){
											  strHtml.push("<option value='"+list[i].value+"' selected='selected'>"+list[i].name+"</option>"); 
										  }else{
										  	  strHtml.push("<option value='"+list[i].value+"'>"+list[i].name+"</option>");
										  }
									  }
									  $$("#alotType").html("");
									  $$("#alotType").html(strHtml.join(""));
									  
								  }
								  mui.trigger(document.getElementById("alotType"),'change');
							  });
							  
							  //设置店长
							  addr.getManagerListByStoreId("storeId="+storeId+"&filter=all", function(data){
								  var allot = allotArr[0];
								  if(data&&data.resultMessage.messageCode=="0000"){
									  var list = data.resultData.body.result;
									  empData.vo.data=list;
									  var strHtml=["<option value=''>请选择分成人员</option>"];
									  for(var i=0;i<list.length;i++){
										  if(allot&&allot.empId==list[i].empId){
											  strHtml.push("<option value='"+list[i].empId+"' selected='selected'>"+(list[i].empName||list[i].empNickName)+"("+list[i].jobTitle+")"+"</option>"); 
										  }else{
										  	  strHtml.push("<option value='"+list[i].empId+"'>"+(list[i].empName||list[i].empNickName)+"("+list[i].jobTitle+")"+"</option>");
										  }
									  }
									  $$("#managerList").html("");
									  $$("#managerList").html(strHtml.join(""));
								  }
								  
								  var rewardMoney = $$("input[name='rewardMoney']").val();
								  
								  if(allot.percent!=""&&allot.percent!=null){
									  $$("input[name='extRewardlist.remark']").val(allot.remark);
									  $$("input[name='extRewardlist.id']").val(0);
									  $$("input[name='extRewardlist.parentId']").val(allot.id?allot.id:allot.parentId);
									  $$("input[name='extRewardlist.percent']").val((allot.percent*100).toFixed(2));
									  $$("input[name='extRewardlist.money']").val((parseFloat(allot.percent)*parseFloat(rewardMoney) ).toFixed(2));
								  }
								  
								  //处理多级分配方案
								  for(var i=1;i<allotArr.length;i++){
									  empData.vo.remark = allotArr[i].remark;
									  empData.vo.id = 0;
									  empData.vo.parentId = allotArr[i].id?allotArr[i].id:allotArr[i].parentId;
									  empData.vo.eid = allotArr[i].empId;
									  empData.vo.percent=parseFloat(allotArr[i].percent*100).toFixed(2);
									  empData.vo.money=(parseFloat(allotArr[i].percent)*parseFloat(rewardMoney) ).toFixed(2);
									  var template = document.getElementById('template-allot').innerHTML;
									  var compiled = Template7(template).compile();
									  var compiledRendered = compiled(empData);
									  $$("#template-allot-content").append(compiledRendered);	
								  }
								  
								  
								  mui.trigger(document.getElementById("alotType"),'change');
								  
								  //权限控制
								  tools.global.merchantFunc();
								  
							  });
						    
			    	  }
				  });
				  
		   }
			  
		   //赏金分配
		   addr.getStoreExtReward("storeId="+storeId,function(resData){	

			  if(resData&&resData.resultMessage.messageCode=="0000"){
				  var json = resData.resultData.body.result;
				  
				  $$("input[name='rewardMoney']").val(json.rewardMoney);
				  $$("input[name='isUpdate']").val(json.isUpdate);
				  $$("input[name='wish']").val(json.wish);

				  if(tools.global.merchants.iseditVal1 == 2){
					  $$('.iseditVal1-switch').remove();
					   //1可修改，2不可修改
					  if(json.isUpdate=="1"){
						  $$('.iseditVal1-checked').val("可修改");
					  }else{
						  $$('.iseditVal1-checked').val("不可修改");
					  }
					  $$('.iseditVal1-checked').show();
				  }else{
					  //1可修改，2不可修改
					  if(json.isUpdate=="1"){
						  $$("#isUpdate").removeClass("mui-active");
					  }else{
						  $$("#isUpdate").addClass("mui-active");
					  }
				  }
				 
				  
				  var allotArr=resData.resultData.body.result.extRewardlist;
				  
				  //当没有分配进入上一级分配 
				  if(allotArr == null || allotArr.length<=0){
					  if(tools.global.merchants && tools.global.merchants.iseditVal1 && tools.global.merchants.iseditVal1 != 2){
						  merchantsReward();	
					  }					  			  
				  }else{
					  //设置奖金分类
					  addr.getClassType("codeClass=System.allot.type", function(data){
						  var allot = allotArr[0];
						  if(data&&data.resultMessage.messageCode=="0000"){
							  var list = data.resultData.body.result;
							  var strHtml=[];
							  for(var i=0;i<list.length;i++){
								  if(allot&&allot.allotPlan==list[i].value){
									  strHtml.push("<option value='"+list[i].value+"' selected='selected'>"+list[i].name+"</option>"); 
								  }else{
								  	  strHtml.push("<option value='"+list[i].value+"'>"+list[i].name+"</option>");
								  }
							  }
							  $$("#alotType").html("");
							  $$("#alotType").html(strHtml.join(""));
						  }
						  mui.trigger(document.getElementById("alotType"),'change');
					  });				  
					  
					  //设置店长
					  addr.getManagerListByStoreId("storeId="+storeId+"&filter=all", function(data){
						  var allot = allotArr[0];
						  if(data&&data.resultMessage.messageCode=="0000"){
							  var list = data.resultData.body.result;
							  empData.vo.data=list;
							  var strHtml=["<option value=''>请选择分成人员</option>"];
							  for(var i=0;i<list.length;i++){
								  if(allot&&allot.empId==list[i].empId){
									  strHtml.push("<option value='"+list[i].empId+"' selected='selected'>"+(list[i].empName||list[i].empNickName)+"("+list[i].jobTitle+")"+"</option>"); 
								  }else{
								  	  strHtml.push("<option value='"+list[i].empId+"'>"+(list[i].empName||list[i].empNickName)+"("+list[i].jobTitle+")"+"</option>");
								  }
							  }
							  $$("#managerList").html("");
							  $$("#managerList").html(strHtml.join(""));
						  }
						  
						  if(allot.percent!=""&&allot.percent!=null){
							  $$("input[name='extRewardlist.remark']").val(allot.remark);
							  $$("input[name='extRewardlist.id']").val(allot.id);
							  $$("input[name='extRewardlist.parentId']").val(allot.parentId);
							  $$("input[name='extRewardlist.percent']").val((allot.percent*100).toFixed(2));
							  $$("input[name='extRewardlist.money']").val((parseFloat(allot.percent)*parseFloat(json.rewardMoney) ).toFixed(2));
						  }
						  
						  //处理多级分配方案
						  for(var i=1;i<allotArr.length;i++){
							  empData.vo.remark = allotArr[i].remark;
							  empData.vo.id = allotArr[i].id;
							  empData.vo.parentId = allotArr[i].parentId;
							  empData.vo.eid = allotArr[i].empId;
							  empData.vo.percent=parseFloat(allotArr[i].percent*100).toFixed(2);
							  empData.vo.money=(parseFloat(allotArr[i].percent)*parseFloat(json.rewardMoney) ).toFixed(2);
							  var template = document.getElementById('template-allot').innerHTML;
							  var compiled = Template7(template).compile();
							  var compiledRendered = compiled(empData);
							  $$("#template-allot-content").append(compiledRendered);	
						  }
						  
						  mui.trigger(document.getElementById("alotType"),'change');
						  
						  //设置权限
						  try{
							  tools.global.merchantFunc();
						  }catch(e){}
						  
					  });
				  }
				  //设置比例
				  
			  }
		  });
				  
		
	
		  //点击保存
		  mui('.mui-content-padded').on('tap','#regbnt',function(e) {			  
			    if($$("#alotType").val() != "allot1003"){
			    	$$("#template-allot-content").html("");
			    }
			    //验证输入
			    if(!tools.is_money($$("input.money"))){
			    	tools.toastTip("错误提示",'金额输入不正确');
			    	return;
			    }
			    var data = $$("#storeInfo").serializeJson();			    
				var datastr=JSON.stringify(data);
				var _this =this;
				addr.editStoreExtReward(datastr,function(resdata){
					if(resdata!=null&&resdata.resultMessage.messageCode=="0000"){
						tools.toast(null,"修改成功");
					}else{
						tools.toast("错误","修改失败");
					}
				});
				
		  });
		  
		  //点击帮助
		  $$("#info").on('tap',function(e){
			  $$("#rega").attr("href","#helppage");
			  mui.trigger(document.getElementById("rega"),'tap');	
			  window.history.pushState({page:"helppage"}, "page", window.location.href);
			  
			  //加载滚动
			  tools.scrollBar(document.getElementById('scroll-content-details'),null);
		  })
		  
		  //点击新增分配方案
		  $$("#add").on('tap',function(e){
			    empData.vo.money=0;
			    empData.vo.percent=0;
			    empData.vo.eid=0;
			    console.log(empData);
			    var template = document.getElementById('template-allot').innerHTML;
				var compiled = Template7(template).compile();
				var compiledRendered = compiled(empData);
				$$("#template-allot-content").append(compiledRendered);				
				
		  });
		  
		  //点击删除新增的分配方案
		  $$("#template-allot-content").on("tap","a",function(i){
			  var index = $$("#template-allot-content").find('a').index($$(this) ) ;
			  $$(".removediv").eq(index).remove();
			  $$(this).parent().remove();
		  });
		  
		  //奖金计算
		  $$("#storeInfo").on("change",".rewardmoney",function(i){
			  var _name = $$(this).attr("name");
			  var index = $$("input[name='"+_name+"']").index($$(this) ) ;	
			  var value = $$(this).val();
			  if(_name == "extRewardlist.money"){				 
				  var obj = $$("input[name='extRewardlist.percent']").eq(index);
				  if(!tools.is_money(value)){
					  obj.val("0");
					  $$(this).val("0");
					  return;
				  }
				  var percent=(parseFloat(value)*100/parseFloat($$("input[name='rewardMoney']").val() ) ).toFixed(2);
				  obj.val(percent);
			  }else{
				  var obj = $$("input[name='extRewardlist.money']").eq(index);
				  if(!tools.is_money(value)){
					  obj.val("0");
					  $$(this).val("0");
					  return;
				  }
				  var money=(parseFloat(value)/100*parseFloat($$("input[name='rewardMoney']").val() ) ).toFixed(2);
				  obj.val(money);
			  }
		  });
		  
		  $$("#storeInfo").on("change","#rewardMoney",function(i){
			  var _this = this;
			  if(!tools.is_money($$(_this).val())){
				  $$("input[name='extRewardlist.money']").val("0");
				  return;
			  }
			  $$("input[name='extRewardlist.money']").each(function(i){
				   var obj = $$("input[name='extRewardlist.percent']").eq(i);
				   var money=(parseFloat(obj.val())/100*parseFloat($$(_this).val() ) ).toFixed(2);
				   $$(this).val(money);
			  });
		  });
	  
	  });

 }); 

	  </script>
</html>			