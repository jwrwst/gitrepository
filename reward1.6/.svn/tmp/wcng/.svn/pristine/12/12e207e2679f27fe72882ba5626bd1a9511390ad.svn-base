<!DOCTYPE html>
<html>
	  <head>
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	    <title>众赏</title>
	    <link href="${basepath}/assets/plugin/mui/dist/css/mui.min.css" rel="stylesheet"/>
	    <link href="${basepath}/assets/def/css/tips.css" rel="stylesheet"/>
	    <link href="${basepath}/assets/def/css/axis.css" rel="stylesheet"/>
	    
	    <link rel="shortcut icon" href="${basepath}/assets/favicon.ico" />	    
	    <style type="text/css">
			.line-border-right{
		       border-right:1px solid #cccccc;
		    }

		    .mui-table-view-cell{
		       padding-bottom:5px;
		    }
		    .em{ 
		       position:relative; 
		       left:-30px; 
		       top:0px;
		       width:20px; 
		       height:20px;
		       font-size:20px;
		       color:#ffffff;
		       
		    }
		    .mui-icon-star{
		    	font-size:12px!important;
		    }
		    
		    .bignum{
		    	font-size:18px;
		    }
		    
		    .mui-media-object{
		      
		       margin-top: 5px;
		    }
		    .mui-media-body{
		    	line-height:40px;
		    } 
		    
	    </style>
	    <style>
		
			.mui-control-content .mui-loading {
				margin-top: 50px;
			}
			.mui-slider-progress-bar{
			    background:#EA4F16!important;
			}
			.mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active {
				color: #EA4F16!important;
				background: 0 0;
				border-bottom: 2px solid #007aff;
			}
		</style>
	  </head>
	  
	  <body> 
	 	<header class="mui-bar mui-bar-nav">
			 <span class="mui-pull-right">
		            <span class="mui-icon iconfont icon-up" style="position: absolute;right:10px;top:6px;color:#cccccc;font-size:12px !important;"></span>								
  					<select class="mui-btn mui-btn-block mui-pull-right" style="width:20%;background: transparent;padding-right:20px;position: absolute;right: 0;" name="dateType" id="dateType">	
  					    <option value="0">今日</option>
  					    <option value="1">昨日</option>
  					    <option value="2">本周</option>
  					    <option value="3">上周</option>
  					    <option value="4">本月</option>
  					    <option value="5">上月</option>	
  					    <option value="6">自定义</option>							
					</select>	
		      </span>      
		     
		      
		      <span class="mui-pull-right">
		            <span class="mui-icon iconfont icon-up" style="position: absolute;right: 30%;top:6px;color:#cccccc;font-size:12px !important;"></span>								
  					<select class="mui-btn mui-btn-block mui-pull-right" style="width:40%;background: transparent;padding-right:20px;position: absolute;right: 20%;" name="storeType" id="storeType">	  					    
  					    <option value="1">全国门店</option>  					   							
					</select>	
		      </span>
		      
		       <span class="mui-pull-right">
		            <span class="mui-icon iconfont icon-up" style="position: absolute;right: 66%;top:6px;color:#cccccc;font-size:12px !important;"></span>								
  					<select class="mui-btn mui-btn-block mui-pull-right" style="width:30%;background: transparent;padding-right:20px;position: absolute;right: 66%;" name="searchType" id="searchType">	
  					    <option value="0" class="employee reward" data-value="0">员工打赏榜</option>
  					    <option value="1" class="employee evaluate" data-value="1">员工评价榜</option>
  					    <option value="2" class="manager reward" data-value="0">门店打赏榜</option>
  					    <option value="3" class="manager evaluate" data-value="1">门店评价榜</option>
  					   								
					</select>	
		      </span>
		  </header> 
		 <div class="mui-content" >
		    <div class="scroller" >
		  		<a href="#resultpage" id="rega" style="display:none;"></a>
		  		<div class="plat-content mui-content">
		  		    <!-- 显示查询日期 -->
		  			<div id="dateWindow-disTime" style="text-align: center;display:none;margin-top:5px;">
		  			   <span style="color:red;padding:0 30px;" id="disStartTime"></span>至 <span style="color:red;padding:0 30px;" id="disEndTime"></span>
		  			</div>
		  			<!-- template-page -->
		  			<div id="slider" class="mui-slider">
						<div id="sliderSegmentedControl" class="mui-segmented-control mui-segmented-control-inverted">
							<a class="mui-control-item mui-active" href="#item1mobile">
								打赏次数榜
							</a>
							<a class="mui-control-item" href="#item2mobile">
								打赏金额榜
							</a>								
						</div>
						<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-6"></div>
						<div class="mui-slider-group">
							<div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
								        <ul class="mui-table-view" id="template-page-content-my0">					
										</ul>
										<ul class="mui-table-view" id="template-page-content0" style="">					
										</ul>
									
							</div>
							<div id="item2mobile" class="mui-slider-item mui-control-content">		
									
										<ul class="mui-table-view" id="template-page-content-my1">					
										</ul>
										<ul class="mui-table-view" id="template-page-content1" style="">					
									    </ul>
																		
							</div>
							
						</div>
					</div>		
					
				  
				</div>
				<!-- 页面底部标题 -->
			</div>
		
            
          </div>  
		</div>
		
		<!-- 弹出日期 -->
		<div  class="dateWindow" style="display:none;">
			<div style="width: 100%;position: absolute;top: 45px;background: white;z-index:99999;">
				<div class="mui-content-padded tips-reginfo-submit" style="margin: 30px 5%;">
					<input type="date" id="startTime" class="mui-input-clear date" placeholder="请选择时间"  style="border: 1px solid #EA4F16;text-align: center;width: 45%;margin-left: 3%;margin-right: 3%;">
					<input type="date" id="endTime" class="mui-input-clear date" placeholder="请选择时间" style="border: 1px solid #EA4F16;text-align: center;width: 45%;">
					<button type="button" class="mui-btn mui-btn-warning mui-btn-block customerDate" style="margin-top:10px;width: 94%;margin-left: 3%;">确定</button>
				</div>
			</div>
			<div style="width: 100%;height:100%;position: absolute;top: 45px;background: rgba(0,0,0,0.3);z-index:99998;">				
			</div>
		</div>
		
	  [#include '../model/menu.html']
	  </body>
	  <script src="${basepath}/assets/plugin/require.js"></script>
	  <script type="text/javascript" src="${basepath}/assets/def/js/tips/tips.js"></script>
	  <!-- 打赏列表模板 -->
	  <script type="text/template" id="template-tips-page">
			{{#each data}}
			<li class="mui-table-view-cell mui-media tips{{index}}" >
							<a data-id="{{empId}}" data-count={{count}}>
								{{#js_compare "this.index < 4"}}
                                   <span class="mui-media-object mui-pull-left"><i class="mui-icon iconfont icon-order" style="font-size:30px !important;color:#EA4F16;"></i></span>
                                   <label class="em">{{index}}</label> 
                                {{else}}
                                    <span class="mui-media-object mui-pull-left"><i class="mui-icon iconfont icon-order" style="font-size:30px !important;color:#fff;"></i></span>
                                    <label class="em" style="color:#ccc;">{{index}}</label> 
								  
                                {{/js_compare}} 
								<span  class="mui-media-body" ><span style="font-size:15px;">{{title}}</span></span>
								<div style="float:right;font-size:14px;">
								    <span style="float:left;padding-right:10px;line-height:40px;">{{count}}次</span>
								    <span style="float:left;line-height:40px;color:#EA4F16;min-width:3.0em;">￥<label style="font-size:1.1em;font-weight:bold;">{{amountCount}}</label></span>
								</div>	
							</a>
			 </li>
			{{/each}}
	  </script>
	  
	  <!-- 评价列表模板 -->
	  <script type="text/template" id="template-evaluate-page">
			{{#each data}}
			<li class="mui-table-view-cell mui-media evalute{{index}}" >
							<a data-id="{{empId}}" data-count={{count}} >								
								{{#js_compare "this.index < 4"}}
                                   <span class="mui-media-object mui-pull-left"><i class="mui-icon iconfont icon-order" style="font-size:30px !important;color:#EA4F16;"></i></span>
                                   <label class="em">{{index}}</label> 
                                {{else}}
                                    <span class="mui-media-object mui-pull-left"><i class="mui-icon iconfont icon-order" style="font-size:30px !important;color:#fff;"></i></span>
                                    <label class="em" style="color:#ccc;">{{index}}</label> 
								  
                                {{/js_compare}}
								<span  class="mui-media-body" ><span style="font-size:15px;">{{title}}</span></span>
								<div style="float:right;font-size:14px;">
								    <span style="float:left;padding-right:10px;line-height:40px;">{{count}}次</span>
								    <span style="float:left;">
								        <div style="text-align:left;color:#EA4F16;font-weight:bold;">{{score}}</div>
								        <div> 
									       <span class="intro-text">
                          					<span class="def-mui-icon ranklist evaluatelist-star{{empId}}" style="color:#cccccc;">
								               <i class="mui-icon iconfont icon-star" data-num=1></i>
								               <i class="mui-icon iconfont icon-star" data-num=2></i>
								               <i class="mui-icon iconfont icon-star" data-num=3></i>
								               <i class="mui-icon iconfont icon-star" data-num=4></i>
								               <i class="mui-icon iconfont icon-star" data-num=5></i>
						                    </span>
						                    <script>
                                                   Template7.global.tools.setStar({{score}}+"",jQuery(".evaluatelist-star{{empId}}").find(".icon-star"),"#F3D958");
                                            <\/script>
                                           </span> 	
										</div>
								    </span>
								</div>	
							</a>
			 </li>
			{{/each}}
	  </script>
	    	  
	  <script type="text/javascript">
	  require(["jquery","mui","mui_view","template7","addr","common","ftscroller"],function($$,M,mui_view,template7,addr,tools){
		  Template7.global = {};
		  Template7.global.tools=tools;
  
		  $$(document).ready(function(){
			  //对应明细查询类型
			  var seachName = ["day","yesterday","week","lastweek","month","lastmonth","customer"];
			  
			  //判断权限		 
			  var addSearchType = function(code){
				  if(code=="1001"){
					  $$("#searchType").html('<option value="1" class="employee evaluate">员工评价榜</option><option value="3" class="manager evaluate">门店评价榜</option>');
				  }else if(code=="1002" ){
					  $$("#searchType").html('<option value="0" class="employee reward">员工打赏榜</option><option value="2" class="manager reward">门店打赏榜</option>');
				  }else{
					  $$("#searchType").html('<option value="0" class="employee reward">员工打赏榜</option><option value="1" class="employee evaluate">员工评价榜</option><option value="2" class="manager reward">门店打赏榜</option><option value="3" class="manager evaluate">门店评价榜</option>');
				  }
				  return this;
			  };
			  addSearchType(window.localStorage.getItem("authCode"));		  
			  
			  //获取历史查询
			  var hisStoreId=null;
			  (function(){
				  var hisDateType=window.localStorage.getItem("dateType");	
				  hisStoreId=window.localStorage.getItem("range-storeId");
				  var hisSearchType=window.localStorage.getItem("range-searchType");
				  var hisStartTime=window.localStorage.getItem("range-startTime");				  
				  var hisEndTime=window.localStorage.getItem("range-endTime");
				  if(hisDateType!=null&&hisDateType!=""){
					  jQuery("#dateType").val(seachName.indexOf(hisDateType));
				  }
				  if(hisSearchType!=null&&hisSearchType!=""){
					  jQuery("#searchType").val(hisSearchType);
				  }
				  if(hisStartTime!=null&&hisStartTime!=""){
					  jQuery("#startTime").val(hisStartTime);
				  }
				  if(hisEndTime!=null&&hisEndTime!=""){
					  jQuery("#endTime").val(hisEndTime);
				  }
				  window.localStorage.removeItem("dateType");	
				  window.localStorage.removeItem("range-storeId");
				  window.localStorage.removeItem("range-searchType");
				  window.localStorage.removeItem("range-startTime");				  
				  window.localStorage.removeItem("range-endTime");
				  
			  })();
			  
			  //获取店铺列表
			  addr.getStoreList('empId='+tools.global.empId+"&orgCode="+window.localStorage.getItem("tip_orgCode"), function(data){
				  if(data&&data.resultMessage.messageCode=="0000"){
					  var list = data.resultData.body.result;
					  var strHtml=[];
					  for(var i=0;i<list.length;i++){
						  //tools.global.storeId = list[0].storeId ; 
						  var tempStoreId = hisStoreId || tools.global.storeId;
						  if(tempStoreId== list[i].storeId){
							  strHtml.push("<option value='"+list[i].storeId+"' selected='selected'  data-qrcode='"+list[i].qrcode+"'>"+list[i].storeName+"</option>");	
						  }else{
							  strHtml.push("<option value='"+list[i].storeId+"'  data-qrcode='"+list[i].qrcode+"'>"+list[i].storeName+"</option>");	
						  }
						  
					  }
					  
					  $$("#storeType").append(strHtml.join(""));					  
					 
				  }		
				  
				 //主页列表
				 loaddata();
				 
			  });
			  //重置参数
			  var reset=function(){
				  $$("#template-page-content0").html("");
				  $$("#template-page-content1").html("");
				  $$("#template-page-content-my0").html("");
				  $$("#template-page-content-my1").html("");	
				  $$("#dateWindow").hide();
				  $$("#dateWindow-disTime").hide();
				  
				  pageNo=1;
				  loaddata();
			  }
			  
			  //日期切换
			  $$("#dateType").on("change",function(){
				  if($$(this).val()==6){
					  $$(".dateWindow").show();
					  return;
				  }
				  reset();
			  });
			  
			  //点击日期重新选择时间
			  $$("#dateWindow-disTime").on("tap",function(){
				  mui.trigger(document.getElementById("dateType"),'change');
			  })
			  
			  //查询类型
			  $$("#searchType").on("change",function(){	  
				  pageNo1=1;
				  reset();
				  
				  if($$("#searchType").val() == 1 || $$("#searchType").val()==3 ){
					  $$("#sliderSegmentedControl").find("a").eq(0).html("评价次数榜");
					  $$("#sliderSegmentedControl").find("a").eq(1).html("评价得分榜");
				  }else{
					  $$("#sliderSegmentedControl").find("a").eq(0).html("打赏次数榜");
					  $$("#sliderSegmentedControl").find("a").eq(1).html("打赏金额榜");
				  }
				  
				  if($$("#searchType").val() == 2 || $$("#searchType").val()==3){
					  $$("#storeType").val(0);
					  $$("#storeType").attr("disabled",true);
				  }else{
					  $$("#storeType").val(tools.global.storeId);
					  $$("#storeType").attr("disabled",false);
				  }
			  });
			  
			  //范围切换
			  $$("#storeType").on("change",function(){
				  pageNo1=1;
				  reset();
				  //查询权限
				  addr.storeAuthDetail("storeId="+jQuery("#storeType").val(),function(data){				 	
					 	if(data.resultMessage.messageCode != "0000"){
					 		return;
					 	}
					 	var json=data.resultData.body.result;					 	
					 	
					 	//加载总数据信息
					 	if(json!=null&&json.length>0){
					 		var code = json[0].authCode;
						 	addSearchType(code);
					 	}else{
					 		addSearchType("1003");
					 	}
					 	

				  });
			  });
			  
			  //按日期查询
			  $$(".customerDate").on("click",function(){
				  reset();
				  $$(".dateWindow").hide();
			  })
        	  
			 //次数与金额切换
			 var item2 = document.getElementById('item2mobile');
			 document.getElementById('slider').addEventListener('slide', function(e) {
				if (e.detail.slideNumber === 1) {
					type = 1;		
					reset();				
								
				}else{
					type = 0;		
					reset();
				
				} 
			 });
			 
			  //点击列表项			  
			  mui(".mui-slider-group").on('tap','a',function(e){
				  //判断查询店铺还是人员
				  if(jQuery("#searchType").val()==2 || jQuery("#searchType").val() == 3){
					 return ;
				  }
				  
				  var count=$$(this).attr("data-count");
				  var empId=$$(this).attr("data-id");
				  if(count==null||count==""||count==0){
					  return ;
				  }
				  //加载基础数据
				  window.localStorage.setItem("range-empId", empId);
				  window.localStorage.setItem("dateType",seachName[$$("#dateType").val()]);
				  window.localStorage.setItem("range-storeId", jQuery("#storeType").val());
				  window.localStorage.setItem("range-startTime",jQuery("#startTime").val());
				  window.localStorage.setItem("range-endTime",jQuery("#endTime").val());
				  window.localStorage.setItem("range-searchType", jQuery("#searchType").val());
				  
				  
				  if(jQuery("#searchType").val()==1 || jQuery("#searchType").val() == 3){
				  	  window.location.href = "${basepath}/views/template/web/tips_store_sub_range-evaluate-details.xhtml";
				  }else{
					  window.location.href = "${basepath}/views/template/web/tips_store_sub_range-tips-details.xhtml";
				  }
				  
				 
				  
			  });
			  
		  });
		  
	  });
	  
	  //日期格式
	  var dateFormat = function(date){
		  try{
			  var year= date.substring(0,4);
			  var month=date.substring(5,7);
			  var day=date.substring(8,10);
			  return year+""+month+day;
		  }catch(e){return "";}
	  }
	  
	  //加载排行列表数据
	  var pageNo=1;
	  var pageNo1=1;
	  var type = 0;
	  var loaddata = function(){ 
		  var addr = require("addr");
		  var tools = require("common");
		  //判断查询店还是全国
		  var storeType=0;
		  var storeId = tools.global.storeId ;
		  if(jQuery("#storeType").val()>1){
			  storeId = jQuery("#storeType").val() ; 
		  }else{
			  storeType = jQuery("#storeType").val(); 
		  }
		  
		  var groupType=1;
		  //判断查询店铺还是人员
		  if(jQuery("#searchType").val()==2 || jQuery("#searchType").val() == 3){
			  groupType = 0;			  
		  }
		  		  
		  //判断查询店铺还是人员
		  var searchType = 0;
		  if(jQuery("#searchType").val()==1 || jQuery("#searchType").val() == 3){
			  searchType = 1;			  
		  }else{
			  searchType = 0;
		  }
		  //判断是否显示日期
		  if(jQuery("#dateType").val()==6){
			  jQuery("#dateWindow-disTime").show();
			  jQuery("#disStartTime").html(jQuery("#startTime").val());
			  jQuery("#disEndTime").html(jQuery("#endTime").val());
		  }else{
			  jQuery("#dateWindow-disTime").hide();
		  }
		  
		  var json={"searchType":searchType,"type":type,"dateType":jQuery("#dateType").val(),"storeId":storeId,"storeType":storeType,groupType:groupType,"numPerPage":"50","pageNum":""+pageNo+"","startTime":dateFormat(jQuery("#startTime").val()),"endTime":dateFormat(jQuery("#endTime").val())};
		  var loadbar=tools.loading();
		  window.setTimeout(function(){
			  loadbar.close();
		  }, 2000);
		  
// 		  if(type ==0 && pageNo>tools.global.totalPages){
// 			 return;
// 		  }
// 		  if(type ==1 && pageNo1>tools.global.totalPages1){
// 			 return;
// 		  }
		 
		  addr.findStorManagerRanking(JSON.stringify(json),function(data){
			  loadbar.close();
			  if(data!=null&&data.resultMessage.messageCode=="0000" &&
				  data.resultData.body.result!=null&&data.resultData.body.result.result.length!=0){
				  
				  if(searchType==1){
					  var template = document.getElementById('template-evaluate-page').innerHTML;				  
					  var compiled = Template7(template).compile();
					  var arrData = data.resultData.body.result.result;
					  var curObj=0;
					  for(var i=0;i<arrData.length;i++){
						  arrData[i].index=(i+1);
						  if(groupType==0){
							  arrData[i].title = arrData[i].storeName;
						  }else{
							  arrData[i].title = arrData[i].empName+"<span style='font-size:13px;color:#ccc;'>("+arrData[i].storeName+")</span>";
						  }
						  
						  if(arrData[i].empId == tools.global.empId){
							  curObj = arrData[i].index;
						  }
					  }
					  var compiledRendered = compiled({data:arrData});

					  jQuery("#template-page-content"+type).append(compiledRendered);
					   
					  if(curObj>0){
						  jQuery("#template-page-content-my"+type).html(jQuery("#template-page-content"+type).find(".evalute"+curObj).css("margin-bottom","10px"));
					  }else{
						  jQuery("#template-page-content-my"+type).html("<li style='margin-bottom:10px;'>你的排名太落后了，请继续加油哦！</li>"); 
					  }
					  
				  }else{
					  var template = document.getElementById('template-tips-page').innerHTML;				  
					  var compiled = Template7(template).compile();
					  var arrData = data.resultData.body.result.result;
					  var curObj=0;
					  for(var i=0;i<arrData.length;i++){
						  arrData[i].index=(i+1);
						  if(groupType==0){
							  arrData[i].title = arrData[i].storeName;
						  }else{
							  arrData[i].title = arrData[i].empName+"<span style='font-size:13px;color:#ccc;'>("+arrData[i].storeName+")</span>";
						  }
						  
						  if(arrData[i].empId == tools.global.empId){
							  curObj = arrData[i].index;
						  }
					  }
					  var compiledRendered = compiled({data:arrData});

					  jQuery("#template-page-content"+type).append(compiledRendered); 
					  if(curObj>0){
					  	  jQuery("#template-page-content-my"+type).html(jQuery("#template-page-content"+type).find(".tips"+curObj).css("margin-bottom","10px"));
					  }else{
						  jQuery("#template-page-content-my"+type).html("<li style='margin-bottom:10px;'>你的排名太落后了，请继续加油哦！</li>"); 
					  }
				  }
				  
				  
// 				  if(type==0){
					  pageNo++;
					  tools.global.totalPages = data.resultData.body.result.totalPages;		
// 				  }else if (type == 1){
// 					  pageNo1++;
// 					  tools.global.totalPages1 = data.resultData.body.result.totalPages;		
// 				  }



			  }
			  
			 
			  
		  });
	  }
	  
	  

	  

	  </script>
</html>			