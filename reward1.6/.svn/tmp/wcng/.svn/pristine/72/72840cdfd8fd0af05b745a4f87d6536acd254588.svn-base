<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>众赏</title>
<link href="${basepath}/assets/plugin/mui/dist/css/mui.min.css"
	rel="stylesheet" />
<link href="${basepath}/assets/def/css/tips.css" rel="stylesheet" />
<link rel="shortcut icon" href="${basepath}/assets/favicon.ico" />
<style>
img.mui-media-object {
	border-radius: 50%;
}

.mui-table-view-cell>.mui-btn.btn-remove {
	position: absolute;
	right: 15px;
	top: 20px; color : #ea4f16;
	border: none;
	background: none;
	color: #ea4f16;
}

.mui-table-view-cell>.mui-btn.btn-edit {
	position: absolute;
	right: 65px;
	top: 20px; color : #7ac292;
	border: none;
	background: none;
	color: #7ac292;
}
.un-divided-list{line-height: 42px;}
.mui-media-body font{ margin-left:10px; color:#999;}
</style>
</head>

<body>
	<!--页面主结构开始-->
	<div id="center" class="mui-views">
		<div class="mui-view">
			<div class="mui-navbar"></div>
			<div class="mui-pages"></div>
		</div>
	</div>

	<div id="regpage">
		<!--页面标题栏开始-->
		<div class="mui-navbar-inner mui-bar mui-bar-nav">
		 <button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav" style="color:#EA4F16;"></span>
				</button>
			<h1 class="mui-center mui-title" style="font-weight: bold;">返回人员管理</h1>
		</div>
		<div class="mui-page-content" id="scroll-content">
			<div class="mui-padded scroller">
				<div class="plat-content">
					<div style='text-align:center;'>
						<p
							style="display: block; text-align: center; font-size: 18px; margin: 20px auto 10px;">请扫描二维码参与分成</p>
						<img src="${properties.host}/rs/qrcode?text=${properties.host}/rs/wechat/goBaseLogin?state=61%26data=${param.data}"
							style='width: 60%; max-width: 300px; display: block; margin: 0 auto 40px;'>
					</div>
					<div class="plat-subtitle">
						已参与分成人数 <font style='color: #ea4f16;'><span id="dividedCount">0</span>人</font>
					</div>
					<ul
						class="mui-table-view mui-table-view-striped mui-table-view-condensed" id="list1">
						<!--  <li class="mui-table-view-cell mui-media">
							<button type="button" class="mui-btn btn-remove">移除</button>
							<button type="button" class="mui-btn btn-edit">编辑</button>
							<div class="mui-table">
								<img class="mui-media-object mui-pull-left"
									src="${basepath}/assets/def/images/logo.png">
								<div class="mui-media-body">
									刘晨露  <font style="color:#999;">经理</font>
									<p class='mui-ellipsis'>分成比例  <font style='color:#000;'>0.08~3%</font></p>
								</div>
							</div>
						</li>  -->
					</ul>
					<div class="plat-subtitle">
						未参与分成人数 <font style='color: #ea4f16;'><span id="dividedCount2">0</span>人 </font>
					</div>
					<ul
						class="mui-table-view mui-table-view-striped mui-table-view-condensed" id="list2"
						style='margin-bottom: 80px;'>
						<!-- <li class="mui-table-view-cell mui-media">
							<button type="button" class="mui-btn btn-remove">移除</button>
							<button type="button" class="mui-btn btn-edit">编辑</button>
							<div class="mui-table">
								<img class="mui-media-object mui-pull-left"
									src="${basepath}/assets/def/images/logo.png">
								<div class="mui-media-body">
									刘晨露  <font style="color:#999;">经理</font>
									<p class='mui-ellipsis'>分成比例  <font style='color:#000;'>0.08~3%</font></p>
								</div>
							</div>
						</li>
						<li class="mui-table-view-cell mui-media">
							<button type="button" class="mui-btn btn-remove">移除</button>
							<button type="button" class="mui-btn btn-edit">编辑</button>
							<div class="mui-table">
								<img class="mui-media-object mui-pull-left"
									src="${basepath}/assets/def/images/logo.png">
								<div class="mui-media-body">
									刘晨露  <font style="color:#999;">经理</font>
									<p class='mui-ellipsis'>分成比例  <font style='color:#000;'>0.08~3%</font></p>
								</div>
							</div>
						</li> -->
					</ul>


				</div>

				<!-- 页面底部标题 -->
			</div>
		</div>
	</div>

	[#include '../model/menu.html']
</body>

<script src="${basepath}/assets/plugin/require.js"></script>
<script type="text/javascript"
	src="${basepath}/assets/def/js/tips/tips.js"></script>

<script type="text/javascript">
	require(["jquery","mui","mui_view","addr","common","template7"],function($$,M,mui_view,addr,tools,template7){
		initDatas(addr,tools);
		//编辑
		mui("body").on('tap', '.btn-edit', function() {
			var li = $(this).parents('li')
			var empId = li.attr('data-empId');
			var empName = li.attr('data-empName');
			var jobTitle = li.attr('data-jobTitle');
			var btnArray = ['否', '是'];
			mui.prompt('',jobTitle, '职位', btnArray, function(e) {
				if (e.index == 1 && e.value != '') {
					//info.innerText = '谢谢你的评语：' + e.value;
					var url = addr.emp.edit;
					var params = {jobTitle:e.value,empId:empId};
					addr.ajaxJson(url,JSON.stringify(params),function(data){
						if(data!=null&&data.resultMessage.messageCode=="0000"){
							initDatas(addr,tools);
							tools.toastTip(null,"修改成功");							
						}else{
							 tools.toastTip(null,"修改失败");
						}
					});
				} else {
					//info.innerText = '你点了取消按钮';
				}
			})

		});
		//移除
		mui("body").on('tap', '.btn-remove', function() {
			var li = $(this).parents('li')
			var empId = li.attr('data-empId');
			var empName = li.attr('data-empName');
			var btnArray = ['否', '是'];
			mui.confirm('确认要移除'+empName, '提示', btnArray, function(e) {
				if (e.index == 1) {
					var url = addr.emp.deleteDivManager;
					var params = "&empId="+empId+"&storeId="+tools.global.storeId;
					addr.getJson(url,params,function(data){
						  li.remove();
						  tools.toastTip(null,"移除成功");
						  var json=tools.global.data;
						  json.assistantCount = json.assistantCount -1;
						  
						  $$(".waternum").html(json.assistantCount+"人");
						  $$("#assistantCount").html("已绑定店员("+json.assistantCount+")");
						  
					  });
				} 
			});
		});
	});
	//加载分成人员列表 
	function initDatas(addr,tools){
		$("#list2").html('');
		$("#list1").html('');
		addr.getDivEmpListByStoreId("storeId="+tools.global.storeId,function(data){
			if(data!=null&&data.resultMessage.messageCode=="0000"){
				var jsons=data.resultData.body.result;
				//分成人数
				var dividedCount = 0;
				var dividedCount2 = 0;
				
				for (var i = 0; i < jsons.length; i++) {
					var da = jsons[i];
					var li = $('<li class="mui-table-view-cell mui-media"></li>');
					li.attr("data-empId",da.empId);
					li.attr("data-empName",da.empName);
					li.attr("data-jobTitle",da.jobTitle);
					li.append('<button type="button" class="mui-btn btn-remove">移除</button>');
					li.append('<button type="button" class="mui-btn btn-edit">编辑</button>');
					var div = $('<div class="mui-table"></div>');
					li.append(div);
					div.append('<img class="mui-media-object mui-pull-left" style="width:42px;height:42px;" src="'+(da.headPic?da.headPic:"${basepath}/assets/def/images/logo.png")+'">');
					var cli = $('<div class="mui-media-body"></div>');
					div.append(cli);
					cli.append(da.empName);
					cli.append('<font style="color:#999;margin-left:5px;">'+(da.jobTitle==null?"":da.jobTitle)+'</font>');
					//未参与分成
					if(da.rewardEmpId == null || da.rewardEmpId == 'null'){
						dividedCount++;
						div.addClass("un-divided-list");
						$("#list2").append(li);
					//参与分成
					}else{
						dividedCount2++;
						cli.append('<p class="mui-ellipsis">分成比例  <font style="color:#000;"">'+da.money+'≈'+da.percent+'</font></p>');
						$("#list1").append(li);
					}
				}
				$("#dividedCount").html(dividedCount2);
				$("#dividedCount2").html(dividedCount);
			}
			tools.scrollBar(document.getElementById('scroll-content-details'),function(){});
		});
	}
</script>	  
</html>
