<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>找回密码</title>
<link href="${basepath}/assets/plugin/mui/dist/css/mui.min.css"
	rel="stylesheet" />
<link href="${basepath}/assets/def/css/tips.css" rel="stylesheet" />
<style>
html,body {
	margin: 0;
	overflow-x: hidden;
}

.mui-bar a.mui-icon,.mui-bar .mui-icon:active {
	color: #EA4F16;
	opacity: 1;
}
</style>
</head>
<body>
	<header class="mui-bar mui-bar-nav">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		<h1 class="mui-title">找回密码</h1>
	</header>
	<!--页面主结构开始-->
	<div class="mui-content">
		<form class="mui-input-group" style="margin-top: 10px;" id="dataForm">
			<div class="mui-input-row">
				<input type="text" placeholder="请输入绑定的手机号" name="mobile" id="inputMobile" readonly="readonly" maxlength="13" style='text-align: left;'/>
			</div>
			<div  class="mui-input-row">
				<label style='width:25%;'>验证码</label>
				<button type="button" class="mui-btn msgs" id= "verificationCode"
			 		style="float: right; margin-top:8px; border:0; width:30%; color:#EA4F16;">获取验证码</button>
				<input style='width:45%;' type="text" id="code" class="c_code_msg" placeholder="请输入短信验证码" name="code" maxlength="4">
			</div>
		</form>
	</div>


	<div class="tips-reginfo-submit"
		style="position: absolute; left: 10px; bottom: 20px; right: 10px;">
		<button type="button" class="mui-btn mui-btn-warning mui-btn-block" id="toNext">下一步</button>
	</div>



</body>
<script src="${basepath}/assets/plugin/require.js"></script>
<script type="text/javascript" src="${basepath}/assets/def/js/tips/tips.js"></script>
<script>

//var account  = localStorage.getItem("_user_account");
var Password = {
		init:function(){
			require([ "jquery", "mui", "mui_view", "addr", "common","ftscroller"],
					function($$, mui, mui_view, addr, tools) {
				var mobilePhone=window.localStorage.getItem("phone");
				Password.initView(addr,mobilePhone);
				Password.initLitenters(addr,tools,mobilePhone);
			});
		},
		
		initLitenters:function(addr,tools,mobilePhone){
			//发送验证码
			mui('body').on('tap','#toNext',function(e){
				//var mobilePhone=window.localStorage.getItem("phone");
				//此处不验证第一步验证码的有效性，在第一步和最后一步验证所有
				//var randomCodeInput=window.localStorage.getItem("randomCodeInput");
				var code = $("#code").val();
				if(code.length<4){
					tools.toastTip("错误","请填写正确的验证码");
					return false;
				}
				var url = addr.user.validateCode;
				var params={"phone":mobilePhone,"msgCode":code};
				var datastr=JSON.stringify(params);
				addr.ajaxJson(url,datastr,function(data){
					if(data!=null&&data.resultMessage.messageCode=="0000"){
						//initDatas(addr,tools);
						window.localStorage.setItem("messageCode",code);
						tools.toastTip(null,"验证成功");
						window.location.href = "tips_merchants_refindpsd3.xhtml";	
					}else{
// 						tools.toastTip(null,"验证失败");
						var result=data.resultData.body.result;
						tools.toastTip(null,result);
						//window.location.href = "tips_merchants_refindpsd3.xhtml";	
					}
				});
			});
			//发送验证码
			mui('body').on('tap','#verificationCode',function(e){
			//$('#verificationCode').on('click',function(e){
				var lock = false;
				var code = $(this);
				if(lock){
					return ;
				}
				lock = true;
				//var phone=$("#phone").val();
				//var params="&phone="+phone;
				var params = $("#dataForm").serializeJson();
				params.phone = params.mobile;
				if(params.phone.length<11){
				     tools.toastTip(null, "请正确输入手机号码");
				     lock = false;
				     return ;
				}
				var i = 60;
				function verificationCode(){
					code.removeClass("msgs1");
					setTimeout(function(){
						code.html(i+"秒");
						i--;
						if(i>=0){
							console.log(i);
							verificationCode();
						}else{
							end();
						}
					}, 1000);
				}
				verificationCode();
				function end(){
					i = 0;
					console.log('end');
					lock = false;
					code.html("重新获取");
				}
				//debugger;
				addr.gainCode(params,function(datas){
					//成功、失败处理
					var status = datas.resultMessage.status;
					if(status == 0){			
						var res = datas.resultData.body.result;
						if(res.statusCode == 1){
							 tools.toastTip(null, "发送成功,请注意查收!");
						}else{
							end();
							tools.toast(null,res.description);	
						}
							
					}else{			
						end();
						tools.toast(null,datas.resultMessage.messageText);
					}
				});
			});
		},
		/**
		 * 页面数据
		 */
		initView:function(addr,mobilePhone){
			//var orgCode  = localStorage.getItem("_user_orgCode");
			//$("#inputMobile").val(account);
			$("#inputMobile").val(mobilePhone);
		}
};
Password.init();
</script>
</html>

















