<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>众赏</title>
<link href="${basepath}/assets/plugin/mui/dist/css/mui.min.css"
	rel="stylesheet" />
<link href="${basepath}/assets/def/css/tips.css" rel="stylesheet" />
<style>
html,body {
	margin: 0;
	overflow-x: hidden;
}

.mui-bar a.mui-icon,.mui-bar .mui-icon:active {
	color: #EA4F16;
	opacity: 1;
}
</style>
</head>
<body>
	<header class="mui-bar mui-bar-nav">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		<h1 class="mui-title">更换手机号</h1>
	</header>
	<!--页面主结构开始-->
	<div class="mui-content plat-content">
		<form class="mui-input-group" style="margin-top: 10px;">
			<div class="mui-input-row">
				<input type="text" id="bindMobile" placeholder="请输入绑定的手机号" name="mobile"  readonly="true" maxlength="13" style='text-align: left;'>
			</div>
			<div  class="mui-input-row">
				<label style='width:25%;'>验证码</label>
				<button type="button" class="mui-btn msgs"
			 		style="float: right; margin-top:8px; border:0; width:30%; color:#EA4F16;" id="messageCode">获取验证码</button>
			 		
				<input style='width:45%;' type="text" class="c_code_msg" placeholder="请输入短信验证码" name="code" id="inputMsgCode" maxlength="6">
				
			</div>
			
		</form>


		<div class="tips-reginfo-submit"
			style="position: absolute; left: 10px; bottom: 20px; right: 10px;z-index: 2;">
			<button type="button" class="mui-btn mui-btn-warning mui-btn-block" id="nextChangePhone">下一步</button>
		</div>
	</div>



</body>
<script src="${basepath}/assets/plugin/require.js"></script>
<script type="text/javascript"
	src="${basepath}/assets/def/js/tips/tips.js"></script>
<script>
	var BindPhone={
			init:function(){
				require([ "jquery", "mui", "mui_view", "addr", "common", "ftscroller" ],
						function($$, mui, mui_view, addr, tools) {
					//tools.loading();
					var phone=window.localStorage.getItem("mobile");
					$("#bindMobile").val(phone);
					BindPhone.initLitenters(tools);
				});
			},
			initLitenters:function(tools){
				var $$ = require("jquery");
				var addr = require("addr");
				mui("body").on('tap', '#nextChangePhone', function() {
					//点击下一步，后台请求验证验证码和手机
					var phone=window.localStorage.getItem("mobile");
					var msgCode=$("#inputMsgCode").val();
					if(phone.length<11){
						tools.toastTip("错误","请填写正确的手机号");
						return false;
					}
					if(msgCode.length<4){
						tools.toastTip("错误","请填写正确的短信验证码");
						BindPhone.errorClearCode();
						return false;
					}
					var params={"phone":phone,"msgCode":msgCode};
					var datastr=JSON.stringify(params);
					var url = addr.user.validateCode;
					addr.ajaxJson(url,datastr,function(data){						
						if(data!=null&&data.resultMessage.messageCode=="0000"){
							//验证成功进入下面页面
							//window.localStorage.setItem("phone",phone);
							window.localStorage.setItem("msgCode",msgCode);
							window.location.href = "tips_tenant_bindphone2.xhtml";	
						}else{
							//验证失败则进行错误信息提示
							console.log(data);
							//tools.toastTip("错误",data.resultData.body.result);
// 							tools.toastTip("错误",data.resultMessage.messageText);
							tools.toast("失败",data.resultData.body.result,function(){
								BindPhone.errorClearCode();
							});
						}
					});	
					//测试成功用的
					//window.location.href = "tips_tenant_bindphone2.xhtml";
				});
				
				var lock = false;
				//发送验证码
				mui("body").on('tap', '#messageCode', function() {
					if(lock){
						return ;
					}
					lock = true;
					var phone=window.localStorage.getItem("mobile");
					if(phone.length<11){
						 tools.toastTip("错误","请正确输入手机号码");
						 BindPhone.errorClearCode();
					     lock = false;
					     return ;
					}
					var i = 60;
					function verificationCode(){
						setTimeout(function(){
							$("#messageCode").html(i--+"s");
							if(i>=0){
								//console.log(i);
								verificationCode();
							}else{
								end();
							}
						}, 1000);
					}
					verificationCode();
					function end(){
						i = 0;
						//console.log('end');
						lock = false;
						$("#messageCode").html("获取验证码");
					}
					var params="&phone="+phone;
					addr.gainCode(params,function(datas){
						//成功、失败处理
						var status = datas.resultMessage.status;
						if(status == 0){			
							var res = datas.resultData.body.result;
							if(res.statusCode == 1){
								tools.toastTip("成功","发送成功,请注意查收!");
							}else{
								end();
								tools.toastTip("错误",res.description);
								BindPhone.errorClearCode();
							}
								
						}else{			
							end();
							tools.toastTip("错误",datas.resultMessage.messageText);
							BindPhone.errorClearCode();
						}
					});
				});
			},
			errorClearCode:function(){
				$("#inputMsgCode").val("");
			}
	}
	BindPhone.init();
</script>
</html>







