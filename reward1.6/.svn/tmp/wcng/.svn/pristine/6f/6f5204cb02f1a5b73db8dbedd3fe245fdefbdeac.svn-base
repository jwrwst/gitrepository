<!DOCTYPE html>
<html>
	  <head>
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	    <title>众赏-我的收入</title>
	    <link href="${basepath}/assets/plugin/mui/dist/css/mui.min.css" rel="stylesheet"/>
	    <link href="${basepath}/assets/def/css/tips.css" rel="stylesheet"/>
	    <link href="${basepath}/assets/def/css/axis.css" rel="stylesheet"/>
	    <link rel="shortcut icon" href="${basepath}/assets/favicon.ico" />
	    <style type="text/css">
		    .mui-table-view-cell span{
		       font-size:13px;
		    }
		    .mui-table-view-cell div{
		       font-size:18px;
		       font-weight:bold;
		    }
		    .mui-page-content{
		       padding-top: 0px;
		    }
		    .header-contains{
		       height:180px;
		       width:100%;
		       text-align: center;	
		       background-color: #fff;
		    }
		    
		    .header{
		    	height:100px;
		    	width:100px;	  
		    	display: inline-block;
 		    	border-radius:90px; 
 		    	background-color:#EA4F16;
/*  		    	background-color:rgba(0, 0, 0, 0); */
 		    	border:1px solid #ccc; 
		    	margin:30px;
		    	overflow: hidden;
		    	position:relative;	
		        z-index:5;     
		    }
		    .header .img{
		    	height:94px;
		    	width:94px;		
/* 		    	background-image: url("${basepath}/assets/def/images/head.jpg"); */
		    	background-size:cover ;
		    	display: inline-block;
 		    	border-radius:90px;		    	 
		    	margin:2px;
		    	overflow: hidden;
		    }
		    .header .edit{
		    	height:20px;
		    	width:95px;
		    	display: inline-block;
		    	background-color: rgba(0, 0, 0, 0.7);
		    	position: relative;
		    	bottom: 30px;
		    	font-size:13px;
		    	color:#fff;
		    	border-bottom-right-radius: 90px;
    			border-bottom-left-radius: 90px;
		    }
		    
		    
		    .setting{
		       background-color:rgb(0,0,0,0);
		       padding:5px 10px;
		       position: absolute;
		       right:20px;
		       top: 20px;
		       height:30px;
		       line-height: 20px;
/* 		       border:1px solid #ccc; */
/* 		       border-radius:5px; */
		       z-index:2;
		    }
		    
		    
		#BgImg{
			position:absolute;
			z-index:-100;
		}

		#canvas{
			z-index:1;
			position:absolute;
		
		}
		
		.mui-btn-green, .mui-btn-positive, .mui-btn-success{
			background-color: #EA4F16;
			border: 1px solid #EA4F16;
		}
		.mui-backdrop{
		    background-color:rgba(0,0,0,.5);
		}   
		#cashpage .mui-page-content {
		    padding-top: 5px!important;
		    height: 100%;
		}
	    </style>
	  </head>
	  
	  <body>   	
	    <!--页面主结构开始-->
		<div id="center" class="mui-views">
			<div class="mui-view">	
			    <div class="mui-navbar" style="display: none;">
				</div>	
				<div class="mui-pages">
				</div>
			</div>
		</div>	
	     
		<div id="regpage" class="mui-page" >		
		  <!--页面标题栏开始-->
		  <div class="mui-navbar-inner mui-bar mui-bar-nav"> 
			
		  </div>
		  <div class="mui-page-content" id="scroll-content" style="padding-top:0px;">
		  	 <div class="scroller">
		  	 
		  		 <span class="mui-pull-left" style="padding:20px;position:absolute;z-index:6;">
		            <span class="mui-icon iconfont icon-up" style="position: absolute;left:88px;top:30px;color:#cccccc;font-size:12px !important;"></span>								
  					<select class="mui-btn mui-btn-block" style="font-size:13px!important;width:100px;background: transparent;padding:5px 20px 5px 0;text-align: left;" name="authType" id="authType">									
					</select>	
		         </span>	
		  		
		  		<a href="" id="rega" style="display:none;"></a>
		  		<div class="plat-content">
<!-- 		  			 <img src='${basepath}/assets/def/images/head_bg.png'  id='BgImg' style="display:none;"/>   -->
                     <img src=''  id='BgImg' style="display:none;"/>
		  			 <canvas id='canvas' ></canvas> 	  
		  			 <div class="header-contains" id="header-contains">   								 	
		  			 	<a class="header">	
		  			 		<span class="img"></span>	  			 		
		  			 		<span class="edit">修改头像</span>
		  			 	</a>		  			    
		  			 </div>
		  			 <a class="setting mui-icon iconfont icon-setting-after" style="color:#EA4F16" id="setingbnt"></a>
				     <ul class="mui-table-view" style="padding:5px 10px;">		              
			            <li class="mui-table-view-cell">
							<span style="font-size:15px;font-weight:bold;"  class="remainmoney"></span><br><label style="font-size:13px;color:#ccc;">可提现金额</label>
							<button type="button" class="mui-btn mui-btn-success mui-icon iconfont icon-reward" id="cashbnt" style="font-size:15px!important;color:#fff;">
								提现
							</button>
						</li>
						<li class="mui-table-view-cell">
				           <div style="background-color: #fff;width:100%;font-size:1.0em;color:#EA4F16;">
							    共收到：<span id="totalmoney"></span>元 打赏，<span id="totalcount"></span>条评价，<span id="avgevaluate"></span>星级服务
							</div>
						</li>
			        </ul> 
			        <!-- 有纪录 -->			       		  			
	  				<div class="content">
					  <div class="wrapper">
					    <div class="main">
					      <hr>
					      <div class="year">				        
					        <div class="list">
					          <!--template-pagedetails-li  -->
					          <ul class="" id="template-pagedetails-li-content"> 
					          </ul>
				            </div>
				          </div>     
				     	</div>
				      </div>
					</div>
					<div class="norecord">
					
					</div>
				  
				  
				</div>	
							
			</div>
			
		  </div>           
		</div>	
		
		<!-- 提取现金页 -->
		<div id="cashpage" class="mui-page" >
		  <!--页面标题栏开始-->
		  <div class="mui-navbar-inner mui-bar mui-bar-nav">					
		  </div>
		  <div class="mui-page-content"  id="scroll-content-details" style="padding-top:0!important;">
		    <div class="scroller">
		    
		  	  <div class="plat-content">
			     <form name = "empInfo" id="empInfo">
					<div class="plat-toptitle mui-navbar-inner" style ="font-weight:bold;line-height: 30px;border-bottom:1px solid #ccc;" >
						提现<span style="float:right;"><span style="height:30px;margin-right:10px;font-size:20px;color:#ccc;">|</span><button type="button" class="mui-btn mui-btn-success" id="cashlogbnt">提现记录</button></span>
					</div>
					<div class="plat-subtitle mui-navbar-inner" style="line-height: 30px;">
						可提现金额：<span style="color:#ff4e00;" class="remainmoney"></span>
					</div>
					
					<div class="mui-input-group" style="margin:0 15px;border-left:1px solid #ccc;border-right:1px solid #ccc;">
						<div class="mui-input-row" style="height:50px;">
							<label style="line-height:1.5">金额<b style="font-size:24px;padding-left: 10px;">￥</b></label>							
							<input type="text"   placeholder="0" name="cashMoney" style="text-align: right;font-size:24px!important;height: 50px;line-height:30px;">
						</div>
																
					</div>
					
					<div>
						<div class="mui-content-padded tips-reginfo-submit" >
						    <input type="hidden" name="create_openId" value="">	
						 	        
					        <button  type="button" class="mui-btn mui-btn-warning mui-btn-block" id="resultbnt">确认提现</button>					        	     
					    </div>
					      
					</div>
			        
			        <div style="margin:10px;">
			        	<div style="font-weight:bold;">说明</div>
			  		 	<div>1．  每次提现金额不能低于2元。</div>
			  		 	<div>2．  提现服务费为提现金额的3%，四舍五入保留到分。</div>
			  		 	<div>3．  到账周期最长为24小时。</div>
			  		 
			        </div>
	
				</form>
			 </div>				
				
			</div>
				
          </div>
		</div>
			
		<!-- 提取成功页 -->
		<div id="resultpage"  class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav" style="display:none;">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-text-left mui-title">提现成功</h1>
			</div>
		
			<div class="mui-page-content">
			  <div class="scroller">
			
				<div class="plat-content">
				   <div class="mui-content">
					<div style="text-align: center;height:120px;padding:10px; ">
						<div style="width:100%;float: left;text-align: center;"><img alt="" src="${basepath}/assets/def/images/success.png"  class="successImg"></div>
						<div style="width:100%;float: left;text-align: center;font-weight:bold;padding:10px 10px;">
							<p style="font-size:24px;color:#EA4F16;margin-bottom:30px;">提现成功!</p>
						</div>
                    </div>
					<div>
						<div class="mui-content-padded tips-reginfo-submit" >		        
					        <button  type="button" class="mui-btn mui-btn-warning mui-btn-block" id="comeMain" >返回我的主页</button>					        	       
					    </div>
					</div>
					
				   </div>

				</div>
				
			  </div>
			</div>
		</div>		
		 [#include 'model/menu.html']
	  </body>
	  
	  <script src="${basepath}/assets/plugin/require.js"></script>
	  <script type="text/javascript" src="${basepath}/assets/def/js/tips/tips.js"></script>
	  <script src="${basepath}/assets/plugin/StackBlur.js"></script>
	  <!--打赏纪录  -->
	  <script type="text/template" id="template-pagedetails-li">   
			{{#each data}} 
				{{if_date date}}
                {{#js_compare "this.recordType===1"}}	
                 <li class="cls">				              
					<p class="intro">
					      <span class="mui-icon iconfont icon-evalute-circle"></span>					                
					</p>
                    <div>	
					<span class="intro-text">收到了评价
                          <span class="def-mui-icon evaluatelist-star{{id}}" style="color:#cccccc;">
								    <i class="mui-icon iconfont icon-star" data-num=1></i>
								    <i class="mui-icon iconfont icon-star" data-num=2></i>
								    <i class="mui-icon iconfont icon-star" data-num=3></i>
								    <i class="mui-icon iconfont icon-star" data-num=4></i>
								    <i class="mui-icon iconfont icon-star" data-num=5></i>
						  </span>
						  <script>
                              Template7.global.tools.setStar({{receivable}}+"",jQuery(".evaluatelist-star{{id}}").find(".icon-star"),"#F3D958");
                          <\/script>
                    </span> 	
					<div  class="intro-time">{{time}}</div>	 
					</div>     		              
					<div class="more">
					   {{remark}}	          	
					   
					</div>
				</li>      
				{{else}}
                   {{#js_compare "this.recordType===0"}}
				   		<li class="cls">				              
						<p class="intro">
					      <span class="mui-icon iconfont icon-tips"></span>					                
						</p>	
						<span class="intro-text">收到了{{paid}}元小费</span> 	
							<div  class="intro-time">{{time}}</div>	      		              
							<div class="more">
					   			<p>					                	
					   			</p>
							</div>
				   		</li>
                  {{else}}
						<li class="cls">				              
						<p class="intro">
					      <span class="mui-icon iconfont icon-tips"></span>					                
						</p>	
						<span class="intro-text">收到了{{paid}}元分成小费</span> 	
							<div  class="intro-time">{{time}}</div>	      		              
							<div class="more">
					   			 {{remark}}	
							</div>
				   		</li>
                  {{/js_compare}}
                {{/js_compare}}
			{{/each}}		  			
  	  </script>	 
  	  <script type="text/javascript">
  	  require(["template7"],function(template7){	  
		  //打赏纪录日期分组
		  Template7.registerHelper('if_date', function (date, options){	
			  if(Template7.global.dateArr==null){
				  Template7.global.dateArr = [];
			  }			  
			  var ret = '';
			  if(Template7.global.dateArr.indexOf(date) < 0 ){
				  ret = '<li class="clsdt">' +
				              '<span class="mui-icon iconfont icon-circle"></span>' +
				              '<span class="intro-text">'+date+'</span> ' +		                
				            '</li>';			  
				  Template7.global.dateArr.push(date);
			  }
			  return ret;
			});
  	  });
  	  </script> 
	  
	  <script type="text/javascript">
	  window.localStorage.setItem("empId","${loginVo.empId}");
	  window.localStorage.setItem("storeId","${loginVo.storeId}");
	  window.localStorage.setItem("tip_orgCode", null);
	  require(["jquery","mui","mui_view","template7","addr","common","jweixin"],function($$,M,mui_view,template7,addr,tools,wx){			  	 
		  Template7.global = {};
		  Template7.global.tools=tools;
		  
		  $$(document).ready(function(){
			  //初始化微信
			  try{tools.initWeiXin(addr);}catch(e){console.log(e);}
			  
			  $$("#header-contains").width($$("body").width());
			  
			  //初始化单页view
			  var viewApi = mui('#center').view({
			  		defaultPage: '#regpage'
			  }); 
		      
			  //获取门店功能列表
			  addr.getStoreAuth("groupCode=001",function(data){
				  var list = data.resultData.body.result;
				  var strHtml=[];
				  var auth=window.localStorage.getItem("meAuthcode");
				  for(var i=0;i<list.length;i++){
					  if(auth!=null&&auth==list[i].authCode){
						strHtml.push("<option value='"+list[i].authCode+"' selected='selected'>"+list[i].authName+"</option>");
					  }else{
					  	strHtml.push("<option value='"+list[i].authCode+"'>"+list[i].authName+"</option>");
					  }
				  }
				  $$("#authType").html("");
				  $$("#authType").html(strHtml.join(""));
				  
				 //加载数据
				  loaddata();
			  });
			  
			  //改变事件
			  $$("#authType").on("change",function(){
				  window.localStorage.setItem("meAuthcode",$$(this).val());
				  //重置数据
				  pageNo=1;
				  $$("#template-pagedetails-li-content").html("");
				  Template7.global.dateArr=[];
				  tools.global.page={};
				 //加载数据
				  loaddata();
			  });
			  
			  //加载基础数据
			  var remainmoney=0;
			  addr.getEmployeeIncomeBaseInfo("empId="+tools.global.empId,function(data){
				  
				  if(data!=null&&data.resultMessage.messageCode=="0000"){
					  var json = data.resultData.body.result;
					  $$(".remainmoney").html((json.remainmoney||0)+"元");
					  remainmoney=json.remainmoney||0;

					  if(json.headpic!=""&&json.headpic!=null){
						  $$(".header .img").css("background-image","url('"+json.headpic+"')");
						  //$$("#BgImg").attr("src",json.headpic);
					  }else{
						  $$(".header .img").css("background-image","url('${basepath}/assets/def/images/head.jpg')");
						  //$$("#BgImg").attr("src","${basepath}/assets/def/images/head_bg.png");
					  }
					  try{
					  //$$(".header .img").imgcomplete(function(){
						  stackBlurImage('BgImg', 'canvas', 1,'header-contains' ); 
					  //});
					  }catch(e){}
					  
					  $$("#totalmoney").html(json.totalmoney||0);
					  $$("#totalcount").html(json.evaluatecount||0);
					  $$("#avgevaluate").html(json.avgevaluate||0);
					  
					  window.localStorage.setItem("level", json.level);
					  
					  window.localStorage.setItem("empId","${loginVo.empId}");
				  }
			  });
			  
			  			  
			  //点击提现
			  $$("#cashbnt").on('tap',function(e){
				  $$("#rega").attr("href","#cashpage");
				  mui.trigger(document.getElementById("rega"),'tap');	
				  
				  window.history.pushState({page:"pagedetails"}, "page", window.location.href);
				
				  tools.scrollBar(document.getElementById('scroll-content-details'),null);
			  });
			  //点击确认提现
			  var flag=true;
			  $$("#resultbnt").on('tap',function(e){
				  if(!flag){
					  flag=false;
					  return;
				  }
				  var loading=tools.loading();
				  window.setTimeout(function(){
					  flag = true;
					  loading.close();
				  }, 2000);
				  
				  var cashMoney = $$("input[name='cashMoney']").val();
				  if(!tools.is_money(cashMoney)){
					  tools.toastTip(null,"请输入正确的金额。");
					  return;
				  }
				  if(parseFloat(cashMoney)<2){
					  tools.toastTip(null,"提现最低金额不能小于2块钱");
					  return;
				  }
				  
				  if(parseFloat(cashMoney)>remainmoney){
					  tools.toastTip(null,"您的余额不足,请重新输入");
					  return;
				  }
				  
				 
				  
				  var json ={cash:cashMoney,empId:tools.global.empId};
				  addr.saveCash(JSON.stringify(json),function(data){
					  flag = true;
					  loading.close();
					  
					  if(data!=null&&data.resultMessage.messageCode=="0000" ){
						  $$("#rega").attr("href","#resultpage");
						  mui.trigger(document.getElementById("rega"),'tap');	
						  
						  //window.history.pushState({page:"pagedetails"}, "page", window.location.href);
					  }
				  });
				  
				 
				
			  });
			  
			  //点击设置
			  $$("#setingbnt").on('tap',function(e){
				  window.location.href=pageUrl+'/tips_me_setinfo.xhtml?loginVo.empId='+tools.global.empId;
				 
			  });
			  
			  //提现纪录
			  $$("#cashlogbnt").on('tap',function(e){				  
				  window.location.href=pageUrl+'/tips_me_sub_cashlog.xhtml?loginVo.empId='+tools.global.empId;				
			  });			  
			  
			  //进入主页
			  $$("#comeMain").on('tap',function(e){				  
				  window.location.href=webserver+'/melogin.xhtml';				
			  });
			  
			  //点击修改头像
			  $$(".header").on("tap",function(){
				  wx.chooseImage({
					    count: 1, // 默认9
					    sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
					    sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
					    success: function (res) {
					        var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
					        var localId=localIds[0];
					        $$(".header").children(".img").css("background-image","url('"+localId+"')");
					        //$$("#BgImg").attr("src",localId);
					        //$$("#BgImg").attr("src","http://www.haihaitech.com/uploadfile/2016/04/04/145970277398379.jpg");

// 					        $$("#BgImg").imgcomplete(function(){
// 								  stackBlurImage('BgImg', 'canvas', 30,'header-contains' ); 
// 							});
					        
					        wx.uploadImage({
					            localId: localId, // 需要上传的图片的本地ID，由chooseImage接口获得
					            isShowProgressTips: 1, // 默认为1，显示进度提示
					            success: function (res) {
					                var serverId = res.serverId; // 返回图片的服务器端ID
					                addr.uploadImg("serverId="+serverId+"&empId="+tools.global.empId,function(data){});
					            }
					        });
					    }
					});
			  })
			  
		  });
	  

	  });
	  

	  //加载分页数据
	  var pageNo=1;
	  var loaddata = function(){
		  var addr = require("addr");
		  var tools = require("common");
		  var json={"numPerPage":10,"empId":tools.global.empId,"pageNum":pageNo,authCode:jQuery("#authType").val()};

		  if(pageNo>tools.global.page.totalPages){
			  try{jQuery("#loading_data_text").html("没有更多数据了")}catch(e){};
			  tools.global.page.isDisplay="none";
			  return;
		  }
		  addr.toEmployeeIncomeListPage(JSON.stringify(json),function(data){
			  if(data!=null&&data.resultMessage.messageCode=="0000" &&
				  data.resultData.body.result!=null&&data.resultData.body.result.result.length!=0){
				  var template = document.getElementById('template-pagedetails-li').innerHTML;
				  var compiled = Template7(template).compile();
				  var compiledRendered = compiled({data:data.resultData.body.result.result });
				  jQuery("#template-pagedetails-li-content").append(compiledRendered);
				  
				  pageNo++;
				  tools.global.page.totalPages = data.resultData.body.result.totalPages;				 
			  }else{
				  tools.global.page.isDisplay="none";
			  }
			  
			  //没有纪录
			  try{
				  if(data.resultData.body.result.totalPages==0){
					  jQuery(".norecord").show();
				  }
			  }catch(e){jQuery(".norecord").show();}
			  
		  });
	  }

	  
	  </script>
</html>			