<!DOCTYPE html>
<html>
	  <head>
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	    <title>众赏-服务员绑定</title>
	    <link href="${basepath}/assets/plugin/mui/dist/css/mui.min.css" rel="stylesheet"/>
	    <link href="${basepath}/assets/def/css/tips.css" rel="stylesheet"/>
	    <link rel="shortcut icon" href="${basepath}/assets/favicon.ico" />
	    <style type="text/css">
	    .mui-page-content{
		       padding-top: 0px;
		    }
	    </style>
	  </head>
	  
	  <body> 	  	
	    <!--页面主结构开始-->
		<div id="center" class="mui-views">
			<div class="mui-view">	
			    <div class="mui-navbar" style="display: none;">
				</div>	
				<div class="mui-pages">
				</div>
			</div>
		</div>
		
	     
		<div id="regpage" class="mui-page" >
		  <!--页面标题栏开始-->
		  <div class="mui-navbar-inner mui-bar mui-bar-nav">	
		  				
		  </div>
		  <div class="mui-page-content"  id="scroll-content">
		     <div class="scroller">
		     
		  		 <a href="" id="rega" style="display:none;"></a>
		  	     <div class="plat-content">
			  	     <div class="plat-toptitle mui-navbar-inner" style ="font-weight:bold;line-height: 30px;border-bottom:1px solid #ccc;" >
								绑定为<span style="color:#EA4F16;">${loginVo.storeName}</span>服务员
					 </div>
				     <form name ="empInfo" id="empInfo">
						<div class="plat-subtitle mui-navbar-inner">
							请妥善填写以下信息
						</div>
						<div class="mui-input-group">
							<div class="mui-input-row">
								<label>编号：</label>
								<input type="text"  class="mui-input-clear" placeholder="请输入您的编号" name="jobNumber" maxlength="50">
							</div>
							<div class="mui-input-row">
								<label>姓名：</label>
								<input type="text" class="mui-input-clear" placeholder="请输入您的姓名" name="name" maxlength="25">
							</div>												
						</div>
						<div class="plat-subtitle">
							签名
						</div>						
						<div class="mui-input-row">
								<textarea id="textarea" rows="5" placeholder="众赏之下，人人勇夫" style="height:60px;" name="signature"></textarea>
						</div>	
						<div class="plat-subtitle">
							个人感谢语
						</div>
						
						<div class="mui-input-row">
								<textarea id="textarea" rows="5" placeholder="谢谢土豪！" style="height:60px;" name="gratitude"></textarea>
						</div>
						<div>
							<div class="mui-content-padded tips-reginfo-submit" >
								<input type="hidden" name="empId" value="${loginVo.empId}">
							    <input type="hidden" name="wxAccount" value="${loginVo.openId}">	
							    <input type="hidden" name="storeId" value="${loginVo.storeId}">
							    <input type="hidden" name="qrCode" value="${loginVo.data}">
							    <input type="hidden" name="nickname" value="${loginVo.nickname}">
							    <input type="hidden" name="gender" value="${loginVo.sex}">
							    <input type="hidden" name="level" value="">
							    <input type="hidden" name="headPic" value="${loginVo.headimgurl}">
							    <input type="hidden" name="homeAddress" value="${loginVo.country}|${loginVo.province}|${loginVo.city}">
						        <button type="button" class="mui-btn mui-btn-warning mui-btn-block" id="regbnt">提交</button>					        	     
						    </div>
						      
						</div>
				
		
					</form>
				</div>
				
			  </div>
             </div>
		</div>
			
		<div id="resultpage"  class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav" style="display:none;">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-text-left mui-title">绑定成功</h1>
			</div>
		
			<div class="mui-page-content">
			<div class="scroller">
			
				<div class="plat-content">				
				   <div class="mui-content">
						<div style="text-align: center;height:120px;padding:10px; ">
							<div style="width:100%;text-align: center;font-weight:bold;padding:10px 10px;">
								<p style='text-align: left; color: #EA4F16;'><img alt="" src="${basepath}/assets/def/images/success.png"  class="successImg" style='width:20px !important;height:20px !important; margin-right:5px; display:inline-block;'>您已成为<span>${loginVo.storeName}</span>服务员</p>
								<p style="font-size:1.2em;">关注众赏公众号，进行收入查询</p>								
							</div>
							<div style="width:100%;">
							<p style='text-align:left;'>1、长按二维码，关注众赏公众号。</p>
							<img alt="" src="${basepath}/assets/def/images/qrcode_weixin.jpg" style="width:40%; margin:0 auto;">
							<p style='text-align:left;'>2、进入公众号后，点击我的 > 我是员工。</p>
							<img alt="" src="${basepath}/assets/def/images/bindofficers.png" style="width:80%; margin:0 auto;"></div>
                        </div>
						<div style="display:none;">
							<div class="mui-content-padded tips-reginfo-submit" >		        
						        <button class="mui-btn mui-btn-warning mui-btn-block" id="comeMain" >进入我的主页</button>					        	       
						    </div>
						</div>
					
				  </div>
			   </div>
			   
			   </div>
			</div>
		</div>
			

		
	  </body>
	  
	  <script src="${basepath}/assets/plugin/require.js"></script>
	  <script type="text/javascript" src="${basepath}/assets/def/js/tips/tips.js"></script>
	  <script type="text/javascript">
	  var empId="${loginVo.empId}";
	  var openId="${loginVo.openId}";
	  var orgStoreId ="";
	  var orgStoreName="";
	  require(["jquery","mui","mui_view","addr","common","ftscroller"],function($$,mui,mui_view,addr,tools){
		  //初始化单页view
		  var viewApi = mui('#center').view({
		  	defaultPage: '#regpage'
		  });
		  
		  $$(document).ready(function(){
			  //查询用户
			  addr.getEmployeeInfo("empId="+empId+"&openId="+openId,function(data){
				  if(data&&data.resultMessage.messageCode=="0000"){
					  var json=data.resultData.body.result;
					  if(json!=null){
						  $$("input[name='jobNumber']").val(json.jobNumber);
						  $$("input[name='name']").val(json.name);
						  $$("textarea[name='signature']").val(json.signature);
						  $$("textarea[name='gratitude']").val(json.gratitude);
						  $$("input[name='empId']").val(json.empId);
						  $$("input[name='level']").val(json.level);
						  
						  orgStoreId = json.storeId;
						  orgStoreName = json.storeName;
						  
					  }

				  }
			  });
			  
			  //tools.scroller.updateDimensions($$("body").width(),$$("body").height());
			  
		  });
		  
		  $$('#regbnt').on('tap',function(e) {
			    var data = $$("#empInfo").serializeJson();
			    if(data.jobNumber==""){
			    	tools.toastTip("","请输入编号");
			    	return;
			    }
			    if(data.name==""){
			    	tools.toastTip("","请输入姓名");
			    	return;
			    }
			    var containSpecial = RegExp(/[(\ )(\~)(\!)(\@)(\#)(\$)(\%)(\^)(\&)(\*)(\()(\))(\-)(\_)(\+)(\=)(\[)(\])(\{)(\})(\|)(\\)(\;)(\:)(\')(\")(\,)(\.)(\/)(\《)(\》)(\?)(\)]+/);      
			    var nickname=$$("input[name=nickname]").val();
			    if(containSpecial.test(nickname) ){
			    	data.nickname = data.name;
			    }
			    data.nickname = data.name;
				var datastr=JSON.stringify(data);
				var _this =this;			
				if(orgStoreId!=""&&orgStoreId>0&&orgStoreId!=data.storeId){
					 var btnArray = ['否', '是'];
					  mui.confirm('您已经绑定过'+orgStoreName+',确认要重新绑定？', '提示', btnArray, function(e) {
							if (e.index == 1) {
								addr.saveEmployee(datastr,function(resdata){					
									if(resdata&&resdata.resultMessage.messageCode=="0000"){
										$$("#rega").attr("href","#resultpage");
										mui.trigger(document.getElementById("rega"),'tap');	
									}else{
										tools.toast("错误","绑定信息失败，请检查二维码有效性");
									}
								});
							}
				  });	
					
				}else{				
					addr.saveEmployee(datastr,function(resdata){					
						if(resdata&&resdata.resultMessage.messageCode=="0000"){
							$$("#rega").attr("href","#resultpage");
							mui.trigger(document.getElementById("rega"),'tap');	
						}else{
							tools.toast("错误","绑定信息失败，请检查二维码有效性");
						}
					});
				}
				
		  });	  
		  
		  
		  mui('.mui-content-padded').on('tap','#comeMain',function(e) {
			   window.location.href = '${basepath}/melogin.xhtml';		  
	      });
		  
		
		
	  
	  });
	  </script>
</html>			