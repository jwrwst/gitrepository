<!DOCTYPE html>
<html>
	  <head>
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	    <title>众赏</title>
	    <link href="${basepath}/assets/plugin/mui/dist/css/mui.min.css" rel="stylesheet"/>
	    <link href="${basepath}/assets/def/css/tips.css" rel="stylesheet"/>
	    <link rel="shortcut icon" href="${basepath}/assets/favicon.ico" />
	    <style type="text/css">
	    .mui-table-view-cell div{ float:left; line-height:42px;}
	    .mui-table-view-cell_width{ max-width:60%; text-overflow:ellipsis; white-space:nowrap; overflow:hidden;}
	    .mui-table-view .mui-media-object{ border-radius:21px;} 
	    span.mui-media-body{ float: left;}
	    </style>
	  </head>
	  
	  <body> 	  	
	    <!--页面主结构开始-->
		<div id="center" class="mui-views">
			<div class="mui-view">	
			    <div class="mui-navbar">
				</div>	
				<div class="mui-pages">
				</div>
			</div>
		</div>	
	     
	    <!-- 列表  -->
		<div id="regpage" class="mui-page" >		
		  <!--页面标题栏开始-->
		  <div class="mui-navbar-inner mui-bar mui-bar-nav">				
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					
				</button>
				<h1 class="mui-center mui-title" style="font-weight:bold;">人员管理</h1>
		  </div>
		  <div class="mui-page-content"  id="scroll-content">
		  	 <div class="scroller">
		  	    <a href="#resultpage" id="rega" style="display:none;"></a> 	 
		  		
		  		<div class="plat-content">
		  		<div class="plat-subtitle">管理层</div>
				    <ul class="mui-table-view">	
				    	<li class="mui-table-view-cell mui-media">
							<a class="mui-navigate-right" data-value="0">								
								<span  class="mui-media-body">区域经理</span>								
								<span style="float:right;padding-right:25px;" class="areaManagernum">0人</span>						
							</a>
			            </li>
			            <li class="mui-table-view-cell mui-media">
							<a class="mui-navigate-right" data-value="1">								
								<span  class="mui-media-body">店长</span>								
								<span style="float:right;padding-right:25px;" class="managernumm">0人</span>						
							</a>
			            </li>
			            </ul>
			            <div class="plat-subtitle">店员</div>
			            <ul class="mui-table-view" style='margin-bottom:80px;'>	
			            <li class="mui-table-view-cell mui-media">
							<a class="mui-navigate-right" data-value="2">								
								<span  class="mui-media-body">参与分成人员 <br /><font style='color:#999;'>在后台工作，不常接触顾客的店员</font></span>								
								<span style="float:right;padding-right:25px;" class="dividednum">0人</span>						
							</a>
			            </li>
			            <li class="mui-table-view-cell mui-media">
							<a class="mui-navigate-right" data-value="3">								
								<span  class="mui-media-body">服务员 <br /><font style='color:#999;'>常接触顾客，可被打赏的店员 </font></span>								
								<span style="float:right;padding-right:25px;" class="waternum">0人</span>						
							</a>
			            </li>					
					</ul>
				</div>
				<!-- 页面底部标题 -->
			 </div>
		  </div>		
            
		</div>
		
		<!-- 纪录详情 -->
		<div id="pagedetails" class="mui-page" >		
		  <!--页面标题栏开始-->
		  <div class="mui-navbar-inner mui-bar mui-bar-nav">
		        <button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav" style="color:#EA4F16;"></span>
				</button>
				<h1 class="mui-pull-left mui-title" style="font-weight:bold;">返回人员管理</h1>
		  </div>
		  <div class="mui-page-content"  id="scroll-content-details">
		     <div class="scroller">
		  		<div class="plat-content" id="template-page-content"> 		       
					  							
				</div>
			  </div>	
							
		  </div>	     

		</div>
	 
	  [#include '../model/menu.html']
	  </body>
	  <script src="${basepath}/assets/plugin/require.js"></script>
	  <script type="text/javascript" src="${basepath}/assets/def/js/tips/tips.js"></script>
	  <!-- 列表模板 -->
	  <script type="text/template" id="template-page">
            {{#js_compare "this.value === '1' "}}
					<div style="text-align: center;padding:10px;font-size:15px;" class="isedit-display">
					   <div style="font-weight:bold;font-size:18px;margin-bottom:10px;">{{storeName}}</div>
					   <div>请扫描二维码绑定为店长</div>
					   <div style="margin:10px 20px;">
							<img alt="" src="${properties.host}/rs/qrcode?text=${properties.host}/rs/wechat/goBaseLogin?state=6%26data={{storeId}}" style="width:80%">
                       </div>
					</div>
					<div>
                        <div class="mui-table-view-divider">店长人数({{keeperCount}})</div>					   
					    <ul class="mui-table-view"  style="border:0px!important" id="template-page-li-content">	      
				             
		            	</ul>
					</div>
    		{{else}}	
				
            {{#js_compare "this.value === '0' "}}
					<div style="text-align: center;padding:10px;font-size:15px;" class="isedit-display">
					   <div style="font-weight:bold;font-size:18px;margin-bottom:10px;">{{storeName}}</div>
					</div>
					<div>
                        <div class="mui-table-view-divider">店长人数({{keeperCount}})</div>					   
					    <ul class="mui-table-view"  style="border:0px!important" id="template-page-li-content">	      
				             
		            	</ul>
					</div>

    		{{else}}	
                    <div style="padding:10px;font-size:15px;" >
					    <div style="font-weight:bold;">如何添加店员？</div>
			  		 	<div>将二维码胸牌分发给店员，店员扫描二维码即可完成添加.</div>
			  		 
			  		 	<div style="font-weight:bold;padding-top:10px;">如何获得二维码胸牌？</div>
			  		 	<div>请点击右下角的“设置”菜单，选择“二维码管理”，下载电子版二维码自助制作，或者申请邮寄成品胸牌。</div>
			  		 	
			  		 	<div>
			  		 	  
			  		 	</div>
					</div>
					<div>
                        <div class="mui-table-view-divider" id="assistantCount">已绑定店员({{assistantCount}})</div>					   
					    <ul class="mui-table-view"  style="border:0px!important"  id="template-page-li-content">	      
				        
		            	</ul>
					</div>
         	{{/js_compare}}
         	{{/js_compare}}
	  </script>
	  
	  <script type="text/template" id="template-page-li">
          
            {{#js_compare "this.value === '1'||  this.value === '0'"}}
				{{#each data}} 
				  <li class="mui-table-view-cell">
						<img alt="" src="{{#js_compare "this.headPic=== '' || this.headPic == null  "}} ${basepath}/assets/def/images/head.jpg {{else}} {{headPic}} {{/js_compare}}" class="mui-media-object mui-pull-left">
                        <div class="mui-table-view-cell_width"> {{#js_compare "this.empName=== '' || this.empName == null "}} {{empNickName}} {{else}} {{empName}} {{/js_compare}} </div>
                  </li>
				{{/each}}
    		{{else}}	
				{{#each data}} 
                   <li class="mui-table-view-cell">
                   <img alt="" src="{{#js_compare "this.headPic=== '' || this.headPic == null  "}} ${basepath}/assets/def/images/head.jpg {{else}} {{headPic}} {{/js_compare}}" class="mui-media-object mui-pull-left">
                   <div class="mui-table-view-cell_width">{{#js_compare "this.empName=== '' || this.empName == null  "}} {{empNickName}} {{else}} {{empName}} {{/js_compare}}</div>
                   <div style="float:right;" class="isedit-display"><a data-id="{{empId}}" data-empName="{{empName}}">移除</a></div>    
                  </li>
				{{/each}}
         	{{/js_compare}}
          	
	  </script>
	  
	  <script type="text/template" id="template-page">
            {{#js_compare "this.value === '1' "}}
					<div style="text-align: center;padding:10px;font-size:15px;" class="isedit-display">
					   <div style="font-weight:bold;font-size:18px;margin-bottom:10px;">{{storeName}}</div>
					   <div>请扫描二维码绑定为店长</div>
					   <div style="margin:10px 20px;">
							<img alt="" src="${properties.host}/rs/qrcode?text=${properties.host}/rs/wechat/goBaseLogin?state=6%26data={{storeId}}" style="width:80%">
                       </div>
					</div>
					<div>
                        <div class="mui-table-view-divider">店长人数({{keeperCount}})</div>					   
					    <ul class="mui-table-view"  style="border:0px!important" id="template-page-li-content">	      
				             
		            	</ul>
					</div>
    		{{else}}	
                    <div style="padding:10px;font-size:15px;" >
					    <div style="font-weight:bold;">如何添加店员？</div>
			  		 	<div>将二维码胸牌分发给店员，店员扫描二维码即可完成添加.</div>
			  		 
			  		 	<div style="font-weight:bold;padding-top:10px;">如何获得二维码胸牌？</div>
			  		 	<div>请点击右下角的“设置”菜单，选择“二维码管理”，下载电子版二维码自助制作，或者申请邮寄成品胸牌。</div>
			  		 	
			  		 	<div>
			  		 	  
			  		 	</div>
					</div>
					<div>
                        <div class="mui-table-view-divider" id="assistantCount">已绑定店员({{assistantCount}})</div>					   
					    <ul class="mui-table-view"  style="border:0px!important"  id="template-page-li-content">	      
				        
		            	</ul>
					</div>
         	{{/js_compare}}
	  </script>

	  <script type="text/javascript">
	  require(["jquery","mui","mui_view","addr","common","template7"],function($$,M,mui_view,addr,tools,template7){
		  var storeQrcode=window.localStorage.getItem("storeQrcode");
		  var storeName = window.localStorage.getItem("storeName");
		  //初始化单页view
		  var viewApi = mui('#center').view({
		  		defaultPage: '#regpage'
		  });
		  
		  $$(document).ready(function(){	
			  addr.getStoreEmpCountByStoreID("storeId="+tools.global.storeId,function(data){
             	  if(data!=null&&data.resultMessage.messageCode=="0000"){
             		  var json= data.resultData.body.result;
             		  tools.global.data=json;
             		  $$(".areaManagernum").html(json.areaManagerCount+"人");
             		  $$(".waternum").html(json.assistantCount+"人");
             		  $$(".managernumm").html(json.keeperCount+"人");
             		  $$(".dividednum").html(json.dividedCount+"人");
             	  } 
			  });
			  
			  //点击列表项
			  mui(".mui-media").on('tap','a',function(e){	  
				  
				  //基础信息
				  var template = document.getElementById('template-page').innerHTML;
				  var compiled = Template7(template).compile();
				  var compiledRendered = compiled({value:$$(this).attr("data-value"),qrcode:storeQrcode,storeId:tools.global.storeId,storeName:storeName,assistantCount:$$(".waternum").html(),keeperCount:$$(".managernumm").html()});
				  $$("#template-page-content").html(compiledRendered); 
				  
				  //控制权限
				  tools.global.merchantFunc();
				  
				  //重置配置项
				  pageNo_detail=1;
				  $$("#template-page-li-content").html("");
				  
				  flag = $$(this).attr("data-value");
				  //店长
				  if(flag == 1){
					  addr.getManagerListByStoreId("storeId="+tools.global.storeId,function(data){
						  if(data!=null&&data.resultMessage.messageCode=="0000"){
							  var template = document.getElementById('template-page-li').innerHTML;				  
							  var compiled = Template7(template).compile();
							  var arrData = data.resultData.body.result;
							  var compiledRendered = compiled({data:arrData,value:flag});

							  $$("#template-page-li-content").append(compiledRendered);
						  }
						  tools.scrollBar(document.getElementById('scroll-content-details'),function(){});
					  });
				  }else if(flag == 0){

					  addr.getJson(addr.emp.getAreaManagerByStoreID,"storeId="+tools.global.storeId,
							function(data){
								  if(data!=null&&data.resultMessage.messageCode=="0000"){
									  var template = document.getElementById('template-page-li').innerHTML;				  
									  var compiled = Template7(template).compile();
									  var arrData = data.resultData.body.result;
									  var compiledRendered = compiled({data:arrData,value:flag});
		
									  $$("#template-page-li-content").append(compiledRendered);
								  }
								  tools.scrollBar(document.getElementById('scroll-content-details'),function(){});
					  });
				  }else if(flag == 2){
						window.location.href = "tips_store_sub_joindevide.xhtml";		
				  }else{
					  loaddata_detail();
					  //滚动条加载员工		  
					  tools.scrollBar(document.getElementById('scroll-content-details'),loaddata_detail);
				  }
				  
				  
				  $$("#rega").attr("href","#pagedetails");
				  mui.trigger(document.getElementById("rega"),'tap');	
				  //scroller.updateDimensions($$("#scroll-content").width(),$$("#scroll-content").height());
				  window.history.pushState({page:"pagedetails"}, "page", window.location.href);
			  });
			  
			  //移除员工
			  $$("#template-page-content").on("tap","a",function(){
				  var empId = $$(this).attr("data-id");
				  var empName = $$(this).attr("data-empName");
				  var _this=this;
				  var btnArray = ['否', '是'];
				  mui.confirm('确认要移除'+empName, '提示', btnArray, function(e) {
						if (e.index == 1) {
							addr.removeEmployee("empId="+empId,function(data){
								  $$(_this).parent().parent().remove();
								  tools.toastTip(null,"移除成功");
								  var json=tools.global.data;
								  json.assistantCount = json.assistantCount -1;
								  
								  $$(".waternum").html(json.assistantCount+"人");
								  $$("#assistantCount").html("已绑定店员("+json.assistantCount+")");
								  
							  });
						} 
				  });				 
				  
				  
			  });
			  
			  
			  
			  
		  });	
		 
	  });
	  
	  //加载明细数据
	  var pageNo_detail=1;
	  var flag = 1;
	  var loaddata_detail=function(_this){
		  if(flag==1)return;
		  var addr = require("addr");
		  var tools = require("common");		  
		  var json={"numPerPage":20,"storeId":tools.global.storeId,"pageNum":pageNo_detail};
		  
		  if(tools.global.page.detail==null){tools.global.page.detail={};}
		  if(pageNo_detail> (tools.global.page.detail.totalPages)){
			  return;
		  }
		  
		  addr.toEmpListPage(JSON.stringify(json),function(data){
			  if(data!=null&&data.resultMessage.messageCode=="0000" &&
				  data.resultData.body.result!=null&&data.resultData.body.result.result.length!=0){
				  
				  var template = document.getElementById('template-page-li').innerHTML;				  
				  var compiled = Template7(template).compile();
				  var arrData = data.resultData.body.result.result;
			
				  var compiledRendered = compiled({data:arrData,value:"2"});

				  jQuery("#template-page-li-content").append(compiledRendered);
				  
				  pageNo_detail++;
				  tools.global.page.detail.totalPages = data.resultData.body.result.totalPages;				 
			  }
			  //控制权限
			  tools.global.merchantFunc();
			  
			  //没有纪录
			  try{
				  if(data.resultData.body.result.totalPages==0){
					  jQuery(".norecord").show();
				  }
			  }catch(e){jQuery(".norecord").show();}
			  
		  });
	  }

	  </script>
</html>			