<!DOCTYPE html>
<html>
	  <head>
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	    <title>众赏</title>
	    <link href="${basepath}/assets/plugin/mui/dist/css/mui.min.css" rel="stylesheet"/>
	    <link href="${basepath}/assets/def/css/tips.css" rel="stylesheet"/>
	    <link href="${basepath}/assets/plugin/mui/dist/css/mui.picker.css" rel="stylesheet" />
		<link href="${basepath}/assets/plugin/mui/dist/css/mui.poppicker.css" rel="stylesheet" />
	    <link rel="shortcut icon" href="${basepath}/assets/favicon.ico" />
	  </head>
	  
	  <body> 	  	
	    <!--页面主结构开始-->
		<div id="center" class="mui-views">
			<div class="mui-view">	
			    <div class="mui-navbar">
				</div>	
				<div class="mui-pages">
				</div>
			</div>
		</div>	
	     
		<div id="regpage" class="mui-page" >
		  <!--页面标题栏开始-->
		  <div class="mui-navbar-inner mui-bar mui-bar-nav">				
				<h1 class="mui-center mui-title" >店铺信息</h1>
		  </div>
		  <div class="mui-page-content">
		  	<div class="scroller">
		  		<div class="plat-content">
			     <form name = "storeInfo" id="storeInfo">
					<div class="mui-input-group">
						<div class="mui-input-row">
							<label>店铺名称</label>
							<input type="text" placeholder="请输入店铺名称" name="storeName" maxlength="100">
						</div>
						<div class="mui-input-row">
							<label>所属分类</label>
							<a id='showCityPicker' class="mui-btn-block" type='button' style='color:#000; font-size:15px; text-align:right; padding-right:15px;'>请选择 ...</a> 
							<input name ="storeType" type="hidden">
							<input name ="codeType" type="hidden">
						</div>
						
						<div class="mui-input-row">
							<label>所在地区</label>
							<a id='showCityPicker3' class="mui-btn-block" type = 'button' style='color:#000; font-size:15px; text-align:right; padding-right:15px;'>请选择 ...</a> 
							<input name ="provinceId" type="hidden">
							<input name ="cityId" type="hidden">
							<input name ="areaId" type="hidden">
						</div>
						<div class="mui-input-row">
							<label >详细地址</label>
							<input type="text"  class="" placeholder="请输入店铺地址" name="address" maxlength="100">
						</div>
						<div class="mui-input-row">
							<label >联系电话</label>
							<input type="text" class="" placeholder="区号+固定号码或手机号" name="telphone" maxlength="13">
						</div>	
						<div class="plat-subtitle" style="background-color: #efeff4;"></div>					
						<div class="mui-input-row">
								<label id="System.store.type">开启功能</label>
								<span class="mui-icon  iconfont icon-up authType" style="right:0px;font-size:12px !important;"></span>								
								<select class="mui-btn mui-btn-block authType isedit-sel" style="min-width:40%;background: transparent;padding-right:20px;text-align: center;" name="authType" id="authType">									
								</select>								
						</div>
						
						<div class="mui-input-row">
							<label>商户名称</label>
							<input type="text" placeholder="扫一扫绑定商户" id="orgName" readonly="readonly" style="color:red;">
							<input type="hidden"  name="orgCode" readonly="readonly">
						</div>
											
					</div>
					
					<div>
						<div class="mui-content-padded tips-reginfo-submit" >
						    <input type="hidden" name="storeId" id="storeId" value="">	
						    <input type="hidden" name="updateUser" id="updateUser" value="">							           
					        <button type="button" class="mui-btn mui-btn-warning mui-btn-block" id="regbnt">保存修改</button>					        	     
					    </div>
					      
					</div>
			
	
				</form>
				</div>
				
				<!-- 页面底部标题 -->
			  </div>
             </div>
		</div>
		
		[#include '../model/menu.html']	
	  </body>
	   
	  
	  <script src="${basepath}/assets/plugin/require.js"></script>
	  <script type="text/javascript" src="${basepath}/assets/def/js/tips/tips.js"></script>
	  
	  <script src="${basepath}/assets/plugin/mui/dist/js/mui.min.js"></script>
	  <script src="${basepath}/assets/plugin/mui/js/mui.picker.js"></script>
	  <script src="${basepath}/assets/plugin/mui/js/mui.poppicker.js"></script>
	  <script type="text/javascript" src="${basepath}/assets/def/js/tips/areaWap.js"></script>
	  <script type="text/javascript" src="${basepath}/assets/def/js/tips/dataWap.js"></script>
	  
	  <script type="text/javascript">
	  require(["jquery","mui","mui_view","addr","common","jweixin"],function($$,M,mui_view,addr,tools,wx){
		  var storeId = window.localStorage.getItem("storeId");
		  var empId = window.localStorage.getItem("empId");
		  $$("#storeId").val(storeId);
		  $$("#updateUser").val(empId);
		  //初始化单页view
		  var viewApi = mui('#center').view({
		  	defaultPage: '#regpage'
		  });
		  
		  $$(document).ready(function(){
			  //初始化微信
			  try{tools.initWeiXin(addr);}catch(e){console.log(e);}
			  
			  //初始化地区
			  function initSelect(da){
				//地区
				AreaWap.init("storeInfo","#showCityPicker3",da.provinceId,da.cityId,da.areaId,function(items,me){
					var t3 = (items[2] || {});
					var text = t3.text==null?"":t3.text;
					$("#showCityPicker3").html((items[0] || {}).text + " " + (items[1] || {}).text + " " +text);
					$("input[name=areaId]").val(t3==null?"":t3.value);
					$("input[name=cityId]").val((items[1] || {}).value);
					$("input[name=provinceId]").val((items[0] || {}).value);

				});
				//类型
				DateWap.init("storeInfo","System.store.type","#showCityPicker",2,[da.storeType,da.codeType],function(items,me){
					$("#showCityPicker").html((items[0] || {}).text + " " + (items[1] || {}).text);
					$("input[name=storeType]").val((items[0] || {}).value);
					$("input[name=codeType]").val((items[1] || {}).value);				
				});
			 }
			  
			  //扫一扫获取商户
			  mui('body').on('tap','#orgName',function(){
				  wx.scanQRCode({
					    needResult: 1, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
					    scanType: ["qrCode","barCode"], // 可以指定扫二维码还是一维码，默认二者都有
					    success: function (res) {
					     	var result = res.resultStr; // 当needResult 为 1 时，扫码返回的结果
					     	addr.getRegisterMerchantsEntity("orgCode="+result+"&openId=-1",function(data){
								 if(data!=null&&data.resultMessage.messageCode=="0000"){
									 var json= data.resultData.body.result;
									 if(json.length>0){
										 $$("input[name='orgCode']").val(result);
										 $$("#orgName").val(json[0].merName);
									 }else{
										 tools.toast(null,"商户不存在");
									 }
									 
								 }else{
									 tools.toast(null,"商户不存在");
								 }
							}); 
					     	
					     	
					    }
				  });
			  });

			  //获取店铺信息
			  addr.getStore("storeId="+storeId, function(data){
				  
				  if(data!=null&&data.resultMessage.messageCode=="0000"){
					  var json= data.resultData.body.result;
					  $$("input[name='storeName']").val(json.storeName);
					  $$("input[name='address']").val(json.address);
					  $$("input[name='telphone']").val(json.telphone);
					  
					  initSelect({});	
					  var str = (json.typeName==null?"": json.typeName)+ " " + (json.codeTypeName==null?"":json.codeTypeName) ;
					  if(str != " "){
					  	$$("#showCityPicker").html(str);
					  }
					  str = (json.provinceName==null?"": json.provinceName)+ " " + (json.cityName==null?"":json.cityName)+ " " +  (json.areaName== null?"":json.areaName);
					  if(str != "  "){
					  	$$("#showCityPicker3").html(str);
					  }
					  //获取开启功能列表
				      var authcode=(json.authlist!=null&&json.authlist.length!=0)?json.authlist[0].authCode:"0";
					  addr.getStoreAuth("groupCode=001",function(data){
						  var list = data.resultData.body.result;
						  var strHtml=[];
						  for(var i=0;i<list.length;i++){
							  if(list[i].authCode == authcode){
								  strHtml.push("<option value='"+list[i].authCode+"' selected='selected'>"+list[i].authName+"</option>");
							  }else{
							  	  strHtml.push("<option value='"+list[i].authCode+"'>"+list[i].authName+"</option>");
							  }
						  }
						  $$("#authType").html("");
						  $$("#authType").html(strHtml.join(""));
						  
						  //加载上级权限
						   addr.getMerchantsByStoreId('storeId='+storeId, function(data){
							  if(data&&data.resultMessage.messageCode=="0000"){
								  var json= data.resultData.body.result;
								  window.localStorage.setItem("merchants", JSON.stringify(json));
								  try{
									  tools.global.merchantFunc();
								  }catch(e){}
							  }					  
							 
						  });
						  //权限控制
						  //tools.global.merchantFunc();
					  });
					  
					 //加载上级机构
					 if(json.storeCode!='0'&& json.storeCode!=""){
						 addr.getRegisterMerchantsEntity("orgCode="+json.storeCode+"&openId=-1",function(data){
							 if(data!=null&&data.resultMessage.messageCode=="0000"){
								 var json= data.resultData.body.result;
								 if(json.length>0){
									 $$("input[name='orgCode']").val(json.storeCode);
									 $$("#orgName").val(json[0].merName);
								 }
								 
							 }
						 }); 
					 }
					 
				  }
			  });
		  });
	  
	 
	
		  mui('.mui-content-padded').on('tap','#regbnt',function(e) {
			    var data = $$("#storeInfo").serializeJson();
			    if($$("input[name='storeName']").val()=="" || $$("input[name='storeName']").val()==null){
			    	tools.toastTip("","请输入店铺名称");
			    	return;
			    }
			    data.storeCode = data.orgCode;
				var datastr=JSON.stringify(data);
				var _this =this;
				addr.editStore(datastr,function(resdata){
					if(resdata&&resdata.resultMessage.messageCode=="0000"){
						tools.toast(null,"修改成功");
						//调用父级操作
					 	window.localStorage.setItem("authCode", $$("#authType").val());
					 	authFunc();
					 	
					}else{
						tools.toast("错误","修改失败");
					};
				});
				
		  });	  
	  
	  });

	  

	  </script>
</html>			