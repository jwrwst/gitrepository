<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>众赏</title>
<link href="${basepath}/assets/plugin/mui/dist/css/mui.min.css"
	rel="stylesheet" />
<link href="${basepath}/assets/def/css/tips.css" rel="stylesheet" />
<style>
html,body {
	margin: 0;
	overflow-x: hidden;
}

.mui-bar a.mui-icon,.mui-bar .mui-icon:active {
	color: #EA4F16;
	opacity: 1;
}
</style>
</head>
<body>
	<header class="mui-bar mui-bar-nav">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		<h1 class="mui-title">绑定新手机号</h1>
	</header>
	<!--页面主结构开始-->
	<div class="mui-content plat-content">
	<p class="mui-table-view-cell">
			重新绑定后，愿手机号码将不能作为登录凭证！
		</p>
		<form class="mui-input-group" style="margin-top: 10px;">
			<div class="mui-input-row">
			                    <label>手机号</label> 
								<input type="text" class="" placeholder="请输入要绑定的新手机号" name="mobile" id="newMobile" maxlength="13">
							</div>
			<div  class="mui-input-row">
								<label style='width:25%;'>验证码</label>
								<button type="button" class="mui-btn msgs"
							 		style="float: right; margin-top:8px; border:0; width:30%; color:#EA4F16;" id="messageCode">获取验证码</button>
								<input style='width:45%;' type="text" class="c_code_msg" placeholder="请输入短信验证码" name="code" id="inputMsgCode" maxlength="6">
								
							</div>
			
		</form>
		
	</div>
	<div class="tips-reginfo-submit"
		style="position: absolute; left: 10px; bottom: 20px; right: 10px;">
		<button type="button" class="mui-btn mui-btn-warning mui-btn-block" id="affirmBind">确定绑定</button>
	</div>
</body>
<script src="${basepath}/assets/plugin/require.js"></script>
<script type="text/javascript" src="${basepath}/assets/def/js/tips/tips.js"></script>
<script type="text/javascript">
	var BindPhone2={
		init:function(){
			require([ "jquery", "mui", "mui_view", "addr", "common", "ftscroller" ],
					function($$, mui, mui_view, addr, tools) {
				BindPhone2.initLitenters(tools);
			});
		},
		initLitenters:function(tools){
			var $$ = require("jquery");
			var addr = require("addr");

			/* $("#newMobile").change(function(){
				var url = addr.mer.checkAccount;
				var phone = $(this).val();
				addr.getJson(url,"account="+phone,function(data){
					if(data!=null&&data.resultMessage.messageCode=="0000"){
						
					}else{
						$(this).attr("value","");
						 tools.toastTip("错误",data.resultMessage.messageText);
					}
				});
			}); */
			
			mui("body").on('tap', '#affirmBind', function() {
				//点击确认，后台请求验证验证码和手机
				var newMobile=$("#newMobile").val();
 				if(newMobile.length<11){
					tools.toastTip("错误","请正确输入手机号码");
 					return false;
 				}
				var inputMsgCode=$("#inputMsgCode").val();
				if(inputMsgCode.length<4){
					tools.toastTip("错误","请输入正确的手机验证码");
					BindPhone2.errorClearCode();
					return false;
				}
				var oldMobile=window.localStorage.getItem("mobile");
				if(newMobile==oldMobile){
					tools.toastTip("错误","请不要修改成相同的手机号");
					return;
				}
				var msgCode=window.localStorage.getItem("msgCode");
				var params={"phone":oldMobile,"msgCode":msgCode,"newMobile":newMobile,"newMsgCode":inputMsgCode};
				var datastr=JSON.stringify(params);
				var url = addr.user.updateBindMobile;
				addr.ajaxJson(url,datastr,function(data){
					var status = data.resultMessage.status;
					if(status == 0){		
						if(data!=null&&data.resultMessage.messageCode=="0000"){
							//验证成功进入下面页面
							tools.toast("成功","更换手机号成功",function(){
								window.location.href = "tips_merchants_account.xhtml";	
							});
						}else{
							//验证失败则进行错误信息提示
							tools.toast("错误",data.resultData.body.result,function(){
								BindPhone2.errorClearCode();
							});

						}
					}else{		
						tools.toast("错误",data.resultMessage.messageText);
						BindPhone2.errorClearCode();
					}
					
				});
			});
			
			var lock = false;
			//发送验证码
			mui("body").on('tap', '#messageCode', function() {
				if(lock){
					return ;
				}
				lock = true;
				var phone=$("#newMobile").val();
				if(phone.length<11){
				     tools.toastTip("错误","请正确输入手机号码");
				     lock = false;
				     return ;
				}
				var i = 60;
				function verificationCode(){
					setTimeout(function(){
						$("#messageCode").html(i--+"s");
						if(i>=0){
							//console.log(i);
							verificationCode();
						}else{
							end();
						}
					}, 1000);
				}
				verificationCode();
				function end(){
					i = 0;
					//console.log('end');
					lock = false;
					$("#messageCode").html("获取验证码");
				}
				var params="&phone="+phone;

				var url = addr.mer.checkAccount;
				var phone = $(this).val();
				addr.getJson(url,"account="+phone,function(data){
					if(data!=null&&data.resultMessage.messageCode=="0000"){
						addr.gainCode(params,function(datas){
							//成功、失败处理
							var status = datas.resultMessage.status;
							if(status == 0){			
								var res = datas.resultData.body.result;
								if(res.statusCode == 1){
									 tools.toastTip("成功","发送成功,请注意查收!");
								}else{
									end();
									tools.toastTip("错误",res.description);
									BindPhone2.errorClearCode();
								}
									
							}else{			
								end();
								tools.toastTip("错误",datas.resultMessage.messageText);
								BindPhone2.errorClearCode();
							}
						});
					}else{
						$(this).attr("value","");
						 tools.toastTip("错误",data.resultMessage.messageText);
					}
				});
			});
		},
		errorClearCode:function(){
			$("#inputMsgCode").val("");
		}
	}
	BindPhone2.init();
</script>
</html>

















