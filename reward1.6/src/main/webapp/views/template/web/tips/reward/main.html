<!DOCTYPE html>
<html>
	  <head>
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	    <title>众赏-我要打赏</title>
	    <link href="${basepath}/assets/plugin/mui/dist/css/mui.min.css" rel="stylesheet"/>
	    <link href="${basepath}/assets/def/css/tips.css" rel="stylesheet"/>
	    <link href="${basepath}/assets/def/css/axis.css" rel="stylesheet"/>
	    <link rel="shortcut icon" href="${basepath}/assets/favicon.ico" />
	    <style type="text/css">
		    .mui-table-view-cell span{
		       font-size:13px;
		    }
		    .mui-table-view-cell div{
		       font-size:18px;
		       font-weight:bold;
		    }
		    .mui-page-content{
		       padding-top: 0px;
		    }
		    .header-contains{
		       height:200px;
		       width:100%;
		       text-align: center;	
		       background-color: #fff;
		    }
		    
		    .header{
		    	height:90px;
		    	width:90px;	  
		    	display: inline-block;
 		    	border-radius:90px; 
/*  		    	background-color:rgba(0, 0, 0, 0); */
/*                 background-color:#EA4F16; */
/*  		    	border:1px solid #ccc;  */
		    	margin: 30px 30px 0;
/* 		    	overflow: hidden; */
		    	position:relative;	
		        z-index:5;     
		    }
		    .header .img{
		    	height:86px;
		    	width:86px;		
/* 		    	background-image: url("${basepath}/assets/def/images/head.jpg"); */
		    	background-size:cover;
		    	display: inline-block;
 		    	border-radius:90px;		    	 
		    	margin:2px;
		    	overflow: hidden;
		    }
		    .header .edit{
/* 		    	height:66px; */
		    	width:66px;	
		    	display: inline-block;		    	
		    	position: relative;
		    	bottom: 0px;
/* 		    	font-size:13px; */
		    	color:#797979;
		    	z-index:2;
		    	margin-top: 10px;
		    }
		    
		    
		    .qrcode{
		       display:none;
		       background-color:rgb(0,0,0,0);
		       padding:10px;
		       position: absolute;
		       right:10px;
		       top: 20px;
		       height:60px;
		       width:60px;
		       line-height: 20px;
/* 		       border:1px solid #ccc; */
/* 		       border-radius:5px; */
		       z-index:2;
		    }
		    
		    .storename{
		       background-color:rgb(0,0,0,0);
		       padding:5px 10px;
		       position: absolute;
		       left:10px;
		       top: 20px;
		       height:30px;
		       line-height: 20px;
		       
		       z-index:2;
		    }
		    .icon-star{
		       font-size:35px!important;
		    }
		    
		    .success{
		       width:150px;
		       height:150px;
		    }
			#BgImg{
				position:absolute;
				z-index:-100;
			}
	
			#canvas{
				z-index:1;
				position:absolute;
/* 			    border-bottom:1px solid #ccc; */
			}
		    
	    </style>
	  </head>
	  
	  <body> 	  	
	    <!--页面主结构开始-->
		<div id="center" class="mui-views">
			<div class="mui-view">	
			    <div class="mui-navbar" style="display: none;">
				</div>	
				<div class="mui-pages">
				</div>
			</div>
		</div>	
	     
		<div id="regpage" class="mui-page" >		
		  <!--页面标题栏开始-->
		  <div class="mui-navbar-inner mui-bar mui-bar-nav">
		      <span class="mui-pull-left">
		            <span class="mui-icon iconfont icon-up" style="position: absolute;left:60px;top:6px;color:#cccccc;font-size:12px !important;"></span>								
  					<select class="mui-btn mui-btn-block" style="width:80px;background: transparent;padding-right:20px;text-align: left;" name="storeType" id="storeType">									
					</select>	
		      </span> 	  					 
			
		  </div>
		  <div class="mui-page-content" id="scroll-content">
		  <div class="scroller">
		  		<a href="" id="rega" style="display:none;"></a>
		  		<div class="plat-content">
		  			 <img src='${basepath}/assets/def/images/head_bg.png'  id='BgImg' style="display:none;"/>  
		  			 <canvas id='canvas' ></canvas> 	  
		  			 <div class="header-contains" id="header-contains">   								 	
		  			 	<a class="header">	
		  			 		<span class="img"></span>	  			 			 		
		  			 	</a>
		  			 	<div class="edit" id="empName" style="width:100%;text-align: center;padding-top:10px;"></div> 
		  			 	<div class="edit" id="signature" style="width:100%;text-align: center;padding-top:10px;"></div> 				  			    
		  			 </div>
		  			 <img class="qrcode"></img>
                     <span class="storename"></span>
			        
			         <div id="template-page-content"></div>			  
				  
				</div>				
				
				
			</div>	
				
		  </div>           
		</div>	
		
			
		<!-- 打赏成功页 -->
		<div id="resultpage"  class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav" style="display:none;">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
			</div>
		
			<div class="mui-page-content"  id="scroll-content-details" >
			  <div class="scroller">
				<div class="plat-content">
				   <div class="mui-content" id="template-result-content">
					
					
				   </div>

				</div>
				
			  </div>
			</div>
		</div>
		
			
		 
	  </body>
	  
	  <script src="${basepath}/assets/plugin/require.js"></script>
	  <script type="text/javascript" src="${basepath}/assets/def/js/tips/tips.js"></script>
	  <script src="${basepath}/assets/plugin/StackBlur.js"></script>
	  <script src="${basepath}/assets/plugin/template/dist/template7.min.js"></script>
	  <script type="text/template" id="template-page">   
		   {{#js_compare "this.authcode === '1001' "}}
                    <!-- 开通评价 -->					 
					<div class="mui-input-row" style="margin:30px 15px;">
                            <div style="text-align:center;margin:0 0 10px;">
                                <span class="def-mui-icon" style="color:#cccccc;">
								    <i class="mui-icon iconfont icon-star" data-num=1></i>
								    <i class="mui-icon iconfont icon-star" data-num=2></i>
								    <i class="mui-icon iconfont icon-star" data-num=3></i>
								    <i class="mui-icon iconfont icon-star" data-num=4></i>
								    <i class="mui-icon iconfont icon-star" data-num=5></i>
								</span>
                            </div>
							<input type="hidden" name="serviceScore">
							<textarea id="textarea" rows="5" placeholder="说点什么" name="evaluate"></textarea>
					</div>			
					
					<div>
						<div class="mui-content-padded tips-reginfo-submit" style="text-align: center;">
					        <button type="button" class="mui-btn mui-btn-warning mui-btn-block"  data-value="3">提交评价</button>
					        				        	     
					    </div>
					      
					</div>
					  
    		{{else}}	
                    <!-- 开通打赏 -->
			        <div class="mui-input-group" style="margin:30px 15px;border-left:1px solid #ccc;border-right:1px solid #ccc;">
						<div class="mui-input-row" style="height:50px;">
							<label style="line-height:1.5">金额<b style="font-size:24px;padding-left: 10px;">￥</b></label>							
							<input type="text"   placeholder="0" name="rewardMoney" value="{{rewardmoney}}" {{#js_compare "this.isupdate === 2 "}} readonly="readonly" {{/js_compare}} style="text-align: right;font-size:24px!important;height: 50px;line-height:30px;">
						</div>
														
					</div>
					<div style="height:30px;width:100%;font-size:1.2em;font-weight:bold;text-align:center;" id="wish">
                             祝您事事顺
                    </div>		
					<div>
						<div class="mui-content-padded tips-reginfo-submit" style="text-align: center;margin: 10px 20px; ">
							{{#js_compare "this.authcode === '1002' "}}						 	        
					        	<button type="button" class="mui-btn mui-btn-warning mui-btn-block" data-value="1">确认打赏</button>
							{{else}}
								<button type="button" class="mui-btn mui-btn-warning mui-btn-block" data-value="2">确认打赏</button>
							{{/js_compare}} 
					        <div style="color:#ccc;">自愿打赏，概不退款</div>					        	     
					    </div>
					      
					</div>
         	{{/js_compare}}  			
  	  </script>	 
  	  
  	  <script type="text/template" id="template-result">   
		   {{#js_compare "this.value === '1' "}}
					<div style="margin:50px;text-align: center;">
					    	<div style="width:100%;float: left;text-align: center;"><img alt="" src="${basepath}/assets/def/images/success.png" class="success"></div>
					    	<div style="color:#EA4F16;font-size:20px;font-weight:bold;float:left;text-align: center;width:100%;margin:20px 0;">
								<div style="font-size:15px;">{{gratitude}}</div>
    						</div>
					</div>
					<div>
						<div class="mui-content-padded tips-reginfo-submit" >		        
					        <button  type="button" class="mui-btn mui-btn-warning mui-btn-block" id="comeMain" data-authcode="1002">再赏一个</button>
					        <button  type="button" class="mui-btn mui-btn-block mui-btn-outlined closeWin" >关闭</button>					        	       
					    </div>
					</div>
          
    	   {{else}}	
 				{{#js_compare "this.value === '2' "}}
					<div style="margin:50px;text-align: center;">
                           <div style="width:100%;float: left;text-align: center;"><img alt="" src="${basepath}/assets/def/images/success.png" class="success"></div>
					    	<div style="color:#EA4F16;font-size:20px;font-weight:bold;float:left;text-align: center;width:100%;margin:20px 0;">
								<div style="font-size:15px;">{{gratitude}}</div>
    						</div>
					</div>
					<div>
						<div class="mui-content-padded tips-reginfo-submit" >		        
					        <button  type="button" class="mui-btn mui-btn-warning mui-btn-block" id="comeMain"  data-authcode="1001">给{{empName}}评价</button>
					        <button  type="button" class="mui-btn mui-btn-block mui-btn-outlined closeWin">下次再说</button>					        	       
					    </div>
					</div>
         		{{else}}	
                    <div style="margin:50px;text-align: center;">
							<div style="width:100%;float: left;text-align: center;"><img alt="" src="${basepath}/assets/def/images/success.png" class="success"></div>
					    	<div style="color:#EA4F16;font-size:20px;font-weight:bold;float:left;text-align: center;width:100%;margin:20px 0;">
								<div style="padding:5px;">感谢您参与评价!</div>
								<div style="font-size:15px;">努力用心，为您服务!</div>
    						</div>
					</div>
					<div>
						<div class="mui-content-padded tips-reginfo-submit" >		        
					        <button  type="button" class="mui-btn mui-btn-block mui-btn-outlined closeWin" >关闭</button>					        				        	       
					    </div>
					</div>
				{{/js_compare}}
         	{{/js_compare}}  			
  	  </script>	
  	  
  	  <script type="text/javascript"></script> 
	  
	  <script type="text/javascript">
	  var openId="${loginVo.openId}";
	  var customerId="${loginVo.customerId}";
	  var host = "${properties.host}";
	  var state="${loginVo.state}";
	  var data = "${loginVo.data}";
	  var empName="";
	  var empInfo={};
	  window.localStorage.setItem("empId", "${loginVo.empId}");
	  require(["jquery","mui","mui_view","template7","addr","common","jweixin"],function($$,M,mui_view,template7,addr,tools,wx){		 
		  
		  $$(document).ready(function(){
			  //初始化微信
			  try{tools.initWeiXin(addr);}catch(e){console.log(e);}
			  
			  //设置模糊头像
			  $$("#header-contains").width($$("body").width());			  
			  
			  //初始化单页view
			  var viewApi = mui('#center').view({
			  		defaultPage: '#regpage'
			  });

			 			  
			  //加载数据			  
			  addr.getEmpHomepageBaseInfoByEmpId("empId="+tools.global.empId,function(resdata){

				  if(resdata&&resdata.resultMessage.messageCode=="0000"){
					  var json = resdata.resultData.body.result;
					  empInfo = json;
					  //
					  
					  $$(".qrcode").attr("src",host+"/rs/qrcode?text="+host+"/rs/wechat/goBaseLogin?state=3%26data="+json.qrcode);
					  $$(".storename").html(json.storename);
					  $$("#empName").html("给"+json.empnickname+"打赏");
					  $$("#signature").html(json.signature);
					  $$("#wish").html(json.wish);
					  if(json.headpic!=""&&json.headpic!=null){
						  $$(".header .img").css("background-image","url('"+json.headpic+"')");
						  //$$("#BgImg").attr("src",json.headpic);
					  }else{
						  $$(".header .img").css("background-image","url('${basepath}/assets/def/images/head.jpg')");
						  //$$("#BgImg").attr("src","${basepath}/assets/def/images/head_bg.png");
					  }
					  $$(".header").css("background-color","#EA4F16");
					  try{
						  //$$(".header .img").imgcomplete(function(){
							  //stackBlurImage('BgImg', 'canvas', 0,'header-contains' ); 
						  //});
					  }catch(e){}
					  
					  tools.global.storeId=json.storeid;
					  empName=json.empnickname;

				
					  //打赏纪录日期分组
					  var template = document.getElementById('template-page').innerHTML;
					  var compiled = Template7(template).compile();
					  var compiledRendered = compiled(json);
					  $$("#template-page-content").html(compiledRendered); 	
					  
					  //获取祝福语
					  if(json.wish == null || json.wish == ""){
						  addr.getStore('storeId='+tools.global.storeId,function(data){
							  if(data&&data.resultMessage.messageCode=="0000"){
								  json = data.resultData.body.result;
								  $$("#wish").html(json.wish);
							  }
						  });
					  }
					  //获取	
					  /**
					  addr.getMerchantsByStoreId('storeId='+tools.global.storeId, function(data){
						  if(data&&data.resultMessage.messageCode=="0000"){
							  var json= data.resultData.body.result;
							  if(json.iseditVal1 == 2){
								  $$("#wish").html(json.wish);
							  }else{
								  addr.getStore('storeId='+tools.global.storeId,function(data){
									  if(data&&data.resultMessage.messageCode=="0000"){
										  json = data.resultData.body.result;
										  $$("#wish").html(json.wish);
									  }
								  });
							  }
							  
						  }					  
						 
					  });
					  **/
				  }
			  });  


			  //点击确认提交
			  var thread=0;
			  mui("#template-page-content").on('tap','button',function(e){
				  var loading = tools.loading();
				  
				  //线程控制
				  if(thread==1)return;
				  thread=1;				  
				  window.setTimeout(function(){thread=0;loading.close();}, 3000);
				  
				  var data_val=$$(this).attr("data-value");
				  //提交评价
				  if(data_val == 3){
					  if($$("input[name='serviceScore']").val()==""){
						  tools.toastTip("错误提示","请选择满意度评价");
						  return;
					  }
					  var transJson={empId:tools.global.empId,storeId:tools.global.storeId,customerId:customerId,serviceScore:$$("input[name='serviceScore']").val(),evaluate:$$("textarea[name='evaluate']").val()};
					  addr.saveEvaluate(JSON.stringify(transJson),function(resdata){
						  if(resdata&&resdata.resultMessage.messageCode=="0000"){
							  var template = document.getElementById('template-result').innerHTML;
							  var compiled = Template7(template).compile();
							  var compiledRendered = compiled({value:data_val,empName:empName});
							  $$("#template-result-content").html(compiledRendered); 
							  
							  $$("textarea[name='evaluate']").blur();
							  
							  $$("#rega").attr("href","#resultpage");
							  mui.trigger(document.getElementById("rega"),'tap');	
							  
							  window.history.pushState({page:"pagedetails"}, "page", window.location.href);
						  }else{
							  tools.toastTip("错误提示","提交评论失败，请检查网络。");
						  }
					  });
					  
				  }	else{
					  var rewardMoney=$$("input[name='rewardMoney']").val();
					  if(!tools.is_money(rewardMoney)){
						  tools.toastTip("错误提示",'金额输入不正确');
						  return;
					  }
					  
					  if(rewardMoney>200){
						  tools.toastTip("错误提示",'金额不能大于200元');
						  return;
					  }
					 
					  var transJson={empId:tools.global.empId,storeId:tools.global.storeId,customerId:customerId,"openId":openId,"empName":empName,"gratitude":empInfo.gratitude,"rewardMoney":rewardMoney};
					  tools.payTo(addr,JSON.stringify(transJson),function(){
						  if(data_val==2){
							  var template = document.getElementById('template-result').innerHTML;
							  var compiled = Template7(template).compile();
							  var compiledRendered = compiled({value:data_val,empName:empName});
							  $$("#template-result-content").html(compiledRendered); 
							  
							  $$("input[name='rewardMoney']").blur();
							  
							  $$("#rega").attr("href","#resultpage");
							  mui.trigger(document.getElementById("rega"),'tap');	
							  
							  window.history.pushState({page:"pagedetails"}, "page", window.location.href);
						  }else{
							  wxJsBridgeReady(function(){
								  WeixinJSBridge.invoke("closeWindow",{},function(e){});
							  });
						  }
					  },function(orderNum){
						  addr.removeReward("orderNum="+orderNum,function(data){});
					  });			
					  
				  }			 
				
				 
			  });
			  //进入主页
			  $$("#template-result-content").on('tap',"#comeMain",function(e){	
				  var template = document.getElementById('template-page').innerHTML;
				  var compiled = Template7(template).compile();
				  empInfo.authcode=$$(this).attr("data-authcode");
				  var compiledRendered = compiled(empInfo);
				  $$("#template-page-content").html(compiledRendered);
				  window.history.back();
				  //window.location.href=webserver+'/waplogin.xhtml?state='+state+'&data='+data;			
			  });	
			  
			  //关闭
			  $$("#template-result-content").on('tap',".closeWin",function(e){	
				  //window.history.back();
				  wxJsBridgeReady(function(){
					  WeixinJSBridge.invoke("closeWindow",{},function(e){});
				  });
				  
                 		
			  });
			  
			  //点击星星
			  $$("#template-page-content").on("tap",".icon-star",function(){
				    var index = $$(this).attr("data-num");
				    $$("input[name='serviceScore']").val(index);
				    $$(".icon-star").css("color","#ccc");
				    for(var i=1;i<=index;i++){
				    	$$("i[data-num='"+i+"']").css("color","#EA4F16");
				    }
			 });
			  
			  //点击显示大图
			  $$(".qrcode").on("tap",function(){
				   
			  })
			  
			 tools.scrollBar(document.getElementById('scroll-content-details'),null);
			  
		  });
	  

	  });
	  

	  var wxJsBridgeReady = function(readyCallback) {  
	        if (readyCallback && typeof readyCallback == 'function') {  
	            var Api = this;  
	            var wxReadyFunc = function () {  
	                readyCallback(Api);  
	            };  
	            if (typeof window.WeixinJSBridge == "undefined"){  
	                if (document.addEventListener) {  
	                    document.addEventListener('WeixinJSBridgeReady', wxReadyFunc, false);  
	                } else if (document.attachEvent) {  
	                    document.attachEvent('WeixinJSBridgeReady', wxReadyFunc);  
	                    document.attachEvent('onWeixinJSBridgeReady', wxReadyFunc);  
	                }  
	            }else{  
	                wxReadyFunc();  
	            }  
	        }  
	   }  
	  
	  </script>
</html>			