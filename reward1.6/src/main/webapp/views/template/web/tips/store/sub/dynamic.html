<!DOCTYPE html>
<html>
	  <head>
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	    <title>众赏</title>
	    <link href="${basepath}/assets/plugin/mui/dist/css/mui.min.css" rel="stylesheet"/>
	    <link href="${basepath}/assets/def/css/tips.css" rel="stylesheet"/>
	    <link href="${basepath}/assets/def/css/axis.css" rel="stylesheet"/>
	    <link rel="shortcut icon" href="${basepath}/assets/favicon.ico" />
	    <style type="text/css">
		    .line-border-right{
		       border-right:1px solid #cccccc;
		    }
		    .line-border-top-right{
		       border-right:1px solid #cccccc;
		       border-top:1px solid #cccccc;
		    }
		    .line-border-top{
		       border-top:1px solid #cccccc;
		    }
		    .mui-table-view-cell span{
		       font-size:13px;
		    }
		    .mui-table-view-cell div{
		       font-size:18px;
		       font-weight:bold;
		    }
		    .numclass{
		       padding: 5px;
		    }
	    </style>
	  </head>
	  
	  <body> 	  	
	    <!--页面主结构开始-->
		<div id="center" class="mui-views">
			<div class="mui-view">	
			    <div class="mui-navbar">
				</div>	
				<div class="mui-pages">
				</div>
			</div>
		</div>	
	     
		<div id="regpage" class="mui-page" >
		
		  <!--页面标题栏开始-->
		  <div class="mui-navbar-inner mui-bar mui-bar-nav">
		      <span class="mui-pull-left">		            								
  					<select class="mui-btn mui-btn-block" style="width:auto;background: transparent;padding-right:20px;text-align: left;position: absolute;" name="storeType" id="storeType">									
					</select>
					<span class="mui-icon iconfont icon-up storeselect" style="position:relative;left:90px;top:6px;color:#cccccc;font-size:12px !important;"></span>	
		      </span>
<!-- 			  <h1 class="mui-title" style="font-weight:bold;">实时数据</h1> -->
		  	  					
			
		  </div>
		  <div class="mui-page-content" id="scroll-content">
		    <div class="scroller">
		    
		  		<div class="plat-content">
				     <ul class="mui-table-view mui-grid-view mui-grid-4 codelist" style="padding:10px;display: none;">
			            <li class="mui-table-view-cell mui-media mui-col-xs-12 mui-col-sm-12 data-title" style="padding: 0px;">
			                  	实时数据
			            </li>
			            
			            <li class="mui-table-view-cell mui-media mui-col-xs-6 mui-col-sm-6 line-border-right" data-code="1001" id="evalutecount">
			                    <span class=""><i class="mui-icon iconfont icon-evalutecount"></i>评价次数</span>
			                    <div class="evaluatedaycount numclass">0</div>
			                    <span class="evaluateyesterdaycount">昨日:0</span>
			            </li>
			            <li class="mui-table-view-cell mui-media mui-col-xs-6 mui-col-sm-6"  data-code="1001">
			                    <span class=""><i class="mui-icon iconfont icon-evalute"></i>服务评级</span>
			                    <div class="evaluatedayscore numclass">0</div>
			                    <span class="def-mui-icon evaluatedayscore-star" style="color:#cccccc;">
								    <i class="mui-icon iconfont icon-star" data-num=1></i>
								    <i class="mui-icon iconfont icon-star" data-num=2></i>
								    <i class="mui-icon iconfont icon-star" data-num=3></i>
								    <i class="mui-icon iconfont icon-star" data-num=4></i>
								    <i class="mui-icon iconfont icon-star" data-num=5></i>
								</span>
			            </li>
			            <li class="mui-table-view-cell mui-media mui-col-xs-6 mui-col-sm-6 "  data-code="1002" id="rewardcount">
			                    <span class=""><i class="mui-icon iconfont icon-rewardcount"></i>打赏次数</span>
			                    <div class="rewarddaycount numclass">0</div>
			                    <span class="rewardyesterdaycount">昨日:0</span>
			            </li>
			            <li class="mui-table-view-cell mui-media mui-col-xs-6 mui-col-sm-6 "  data-code="1002" id="rewardmoney">
			                    <span class=""><i class="mui-icon iconfont icon-rewardmoney"></i>打赏总额</span>
			                    <div class="rewarddaymoney numclass">0</div>
			                    <span class="rewardyesterdaymoney">昨日:0</span>
			            </li>
			          
			        </ul> 
			        <!-- 有纪录 -->			       		  			
	  				<div class="content">
					  <div class="wrapper">
					    <div class="main">
					      <hr>
					      <div class="year">				        
					        <div class="list">
					          <!--template-pagedetails-li  -->
					          <ul class="" id="template-pagedetails-li-content"> 
					          </ul>
				            </div>
				          </div>     
				     	</div>
				      </div>
					</div>
					<!-- 没有纪录 -->
					<div class="norecord" style="display:none;font-size:13px;padding:10px;">
						<div style="font-weight:bold;">如何添加店员？</div>
			  		 	<div>将二维码胸牌分发给店员，店员扫描二维码即可完成添加.</div>
			  		 
			  		 	<div style="font-weight:bold;padding-top:10px;">如何获得二维码胸牌？</div>
			  		 	<div>请点击右下角的“设置”菜单，选择“二维码管理”，下载电子版二维码自助制作，或者申请邮寄成品胸牌。</div>
			  		 	
			  		 	<div>
<!-- 			  		 	   <img alt="" src="${basepath}/assets/def/image/head.jpg" style="width:100%;"> -->
			  		 	</div>
					</div>
				  
				  
				</div>		
			
			</div>
				
		  </div>		            
		</div>	
		
		[#include '../model/menu.html']		 
	  </body>
	  
	  <script src="${basepath}/assets/plugin/require.js"></script>
	  <script type="text/javascript" src="${basepath}/assets/def/js/tips/tips.js"></script>
	  <!--打赏纪录  -->
	  <script type="text/template" id="template-pagedetails-li">   
			{{#each data}} 
				{{if_date date}}
                {{#js_compare "this.recordType===0"}}			        	          
				<li class="cls">				              
					<p class="intro">
					      <span class="mui-icon iconfont icon-tips"></span>					                
					</p>	
					<span class="intro-text">{{nickname}}收到了{{receivable}}元小费</span> 	
					<div class="intro-time">{{time}}</div>	      		              
					<div class="more">
					   {{remark}}
					</div>
				</li>
				{{else}}
				<li class="cls">				              
					<p class="intro">
					      <span class="mui-icon iconfont icon-evalute-circle"></span>					                
					</p>
                    <div>	
					<span class="intro-text">{{nickname}}收到了评价
                          <span class="def-mui-icon evaluatelist-star{{id}}" style="color:#cccccc;">
								    <i class="mui-icon iconfont icon-star" data-num=1></i>
								    <i class="mui-icon iconfont icon-star" data-num=2></i>
								    <i class="mui-icon iconfont icon-star" data-num=3></i>
								    <i class="mui-icon iconfont icon-star" data-num=4></i>
								    <i class="mui-icon iconfont icon-star" data-num=5></i>
						  </span>
						  <script>
                              Template7.global.tools.setStar({{receivable}},jQuery(".evaluatelist-star{{id}}").find(".icon-star"),"#F3D958");
                          <\/script>
                    </span> 	
					<div class="intro-time">{{time}}</div>	 
					</div>     		              
					<div class="more">
					   {{remark}}					                	
					   
					</div>
				</li>
                {{/js_compare}}
			{{/each}}		  			
  	  </script>	 
  	  <script type="text/javascript">
  	  require(["template7"],function(template7){	  
		  //打赏纪录日期分组
		  Template7.registerHelper('if_date', function (date, options){	
			  if(Template7.global.dateArr==null){
				  Template7.global.dateArr = [];
			  }			  
			  var ret = '';
			  if(Template7.global.dateArr.indexOf(date) < 0 ){
				  ret = '<li class="clsdt">' +
				              '<span class="mui-icon iconfont icon-circle"></span>' +
				              '<span class="intro-text">'+date+'</span> ' +		                
				            '</li>';			  
				  Template7.global.dateArr.push(date);
			  }
			  return ret;
			});
  	  });
  	  </script> 
	  
	  <script type="text/javascript">	  
	  require(["jquery","mui","mui_view","template7","addr","common"],function($$,M,mui_view,template7,addr,tools){		 
		  var empId= window.localStorage.getItem("empId");
		  var storeId = window.localStorage.getItem("storeId");
		  Template7.global = {};
		  Template7.global.tools=tools;
		  
		  $$(document).ready(function(){
			  //初始化单页view
			  var viewApi = mui('#center').view({
			  		defaultPage: '#regpage'
			  });	 
			  
			  //店铺切换
			  $$("#storeType").on("change",function(){
				  storeId = $$("#storeType").val();	
				  window.localStorage.setItem("storeQrcode", $$("#storeType option:selected").attr("data-qrcode"));
				  window.localStorage.setItem("storeName", $$("#storeType option:selected").text());
				  //重置参数
				  Template7.global = {};
		  		  Template7.global.tools=tools;
				  jQuery("#template-pagedetails-li-content").html("");
				  pageNo =1;
				  tools.global.storeId=storeId;
				  jQuery(".norecord").hide();
				  tools.global.page={};
				  //加载数据
				  loading();		
				  
			  });
			  
			  //加载数据
			  var loading=function(){
				  window.localStorage.setItem("storeId",$$("#storeType").val());
				  tools.global.storeId = $$("#storeType").val();
				  //获取店铺列表权限
				  addr.storeAuthDetail("storeId="+storeId,function(data){				 	
					 	if(data.resultMessage.messageCode != "0000" 
					 			|| data.resultData.body.result == null
				  				|| data.resultData.body.result.length == 0 ){
					 		return;
					 	}
					 	var json=data.resultData.body.result;					 	
					 	//调用父级操作
					 	window.localStorage.setItem("authCode", json[0].authCode);
					 	authFunc();
					 	
					 	//加载总数据信息
					 	var code = json[0].authCode;
					 	if(code=="1003"){
					 		$$("#rewardcount").addClass("line-border-top-right");
					 		$$("#rewardmoney").addClass("line-border-top");
					 		$$(".codelist").children("li").show();
					 		$$(".codelist").show();
					 	}else{
					 		$$("#rewardmoney").removeClass("line-border-top");
					 		$$("#rewardcount").removeClass("line-border-top-right").addClass("line-border-right");
					 		$$(".codelist").children("li").each(function(){
								if(code!=$$(this).attr("data-code")){
									$$(this).hide();
								}
							});
					 		$$(".codelist").show();
					 	}
					 	
					 	$$(".data-title").show();
				  });
				  //加载总数据
				  addr.getStoreDynamicByStoreId("storeId="+storeId,function(data){
					  if(data!=null&&data.resultMessage.messageCode=="0000"){
						 var json= data.resultData.body.result;
						 // body: Object  evaluatedaycount: 5evaluatedayscore: 4.5evaluateyesterdaycount: 0evaluateyesterdayscore: 0rewarddaycount: 5rewarddaymoney: 19.37rewardyesterdaycount: 0rewardyesterdaymoney: 0
						 $$(".evaluatedaycount").html(json.evaluatedaycount||0);
						 $$(".evaluateyesterdaycount").html("昨日:"+json.evaluateyesterdaycount||0);
						 $$(".evaluatedayscore").html(json.evaluatedayscore||0);
						 if(parseFloat(json.evaluatedayscore)>parseFloat(json.evaluateyesterdayscore)){
							 $$(".evaluatedayscore").html(json.evaluatedayscore+'<i class="mui-icon iconfont icon-down"></i>');
						 }else if(parseFloat(json.evaluatedayscore)<parseFloat(json.evaluateyesterdayscore)){
							 $$(".evaluatedayscore").html(json.evaluatedayscore+'<i class="mui-icon iconfont icon-down" style="-webkit-transform: rotate(180deg);"></i>');
						 }
						 tools.setStar(json.evaluatedayscore,$$(".evaluatedayscore-star").find(".icon-star"));
						 
						 $$(".rewarddaycount").html(json.rewarddaycount||0);
						 $$(".rewarddaymoney").html(json.rewarddaymoney||0);
						 $$(".rewardyesterdaycount").html("昨日:"+json.rewardyesterdaycount||0);
						 $$(".rewardyesterdaymoney").html("昨日:"+json.rewardyesterdaymoney||0);
						 
					  }
					 
					  tools.scroller.refresh() ;
				  });
				  
				   //加载上级权限
				   addr.getMerchantsByStoreId('storeId='+storeId, function(data){
					  if(data&&data.resultMessage.messageCode=="0000"){
						  var json= data.resultData.body.result;
						  window.localStorage.setItem("merchants", JSON.stringify(json));
						  try{
							  tools.global.merchantFunc();
						  }catch(e){}
					  }					  
					 
				  });
				  
				  
				  //加载明细数据
				  loaddata();
			  }
			  
			  
			  addr.getStoreList('empId='+empId+"&orgCode="+window.localStorage.getItem("tip_orgCode"), function(data){
				  if(data&&data.resultMessage.messageCode=="0000"){
					  var list = data.resultData.body.result;
					  var strHtml=[];
					  for(var i=0;i<list.length;i++){
						  if(storeId && storeId == list[i].storeId){
							  window.localStorage.setItem("storeQrcode", list[i].qrcode);
							  window.localStorage.setItem("storeName", list[i].storeName);
							  strHtml.push("<option value='"+list[i].storeId+"' selected='selected' data-qrcode='"+list[i].qrcode+"'>"+list[i].storeName+"</option>");
						  }else{
						  	  strHtml.push("<option value='"+list[i].storeId+"'  data-qrcode='"+list[i].qrcode+"'>"+list[i].storeName+"</option>");
						  }
					  }
					  $$("#storeType").html("");
					  $$("#storeType").html(strHtml.join(""));
				  }
				  $$(".storeselect").css("left",$$("#storeType").width()+"px");
				  
				  storeId = $$("#storeType").val();					  
				  //加载数据
				  loading();
			  });
			  
		  });
	  

	  });
	  
	  //加载分页数据
	  var pageNo=1;
	  var loaddata = function(){
		  var addr = require("addr");
		  var tools = require("common");
		  if(tools.global.storeId<1)return;
		  
		  var json={"numPerPage":10,"storeId":tools.global.storeId,"pageNum":pageNo};
		  if(pageNo>tools.global.page.totalPages){
			  try{jQuery("#loading_data_text").html("没有更多数据了")}catch(e){};
			  tools.global.page.isDisplay="none";
			  return;
		  }
		  addr.toDynamicListPage(JSON.stringify(json),function(data){
			  if(data!=null&&data.resultMessage.messageCode=="0000" &&
				  data.resultData.body.result!=null&&data.resultData.body.result.result.length!=0){
				  var template = document.getElementById('template-pagedetails-li').innerHTML;
				  var compiled = Template7(template).compile();
				  var compiledRendered = compiled({data:data.resultData.body.result.result });
				  jQuery("#template-pagedetails-li-content").append(compiledRendered);
				  
				  pageNo++;
				  tools.global.page.totalPages = data.resultData.body.result.totalPages;				 
			  }else{
				  tools.global.page.isDisplay="none";
			  }
			  
			  //没有纪录
			  try{
				  if(data.resultData.body.result.totalCount==0){
					  jQuery(".norecord").show();
				  }
			  }catch(e){jQuery(".norecord").show();}

			  tools.scroller.refresh() ;
		  });
	  }

	  </script>
</html>			