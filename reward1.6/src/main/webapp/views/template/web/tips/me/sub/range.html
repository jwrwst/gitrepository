<!DOCTYPE html>
<html>
	  <head>
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	    <title>众赏</title>
	    <link href="${basepath}/assets/plugin/mui/dist/css/mui.min.css" rel="stylesheet"/>
	    <link href="${basepath}/assets/def/css/tips.css" rel="stylesheet"/>
	    <link href="${basepath}/assets/def/css/axis.css" rel="stylesheet"/>
	    <link rel="shortcut icon" href="${basepath}/assets/favicon.ico" />
	    <style type="text/css">
			.line-border-right{
		       border-right:1px solid #cccccc;
		    }

		    .mui-table-view-cell{
		       padding-bottom:5px;
		    }
		    .em{ 
		       position:relative; 
		       left:-30px; 
		       top:0px;
		       width:20px; 
		       height:20px;
		       font-size:20px;
		       color:#ffffff;
		       
		    }
		    .mui-icon-star{
		    	font-size:12px!important;
		    }
		    
		    .bignum{
		    	font-size:18px;
		    }
		    
		    .mui-media-object{
		      
		       margin-top: 5px;
		    }
		    .mui-media-body{
		    	line-height:40px;
		    }
		  
	    </style>
	    <style>
		
			.mui-control-content .mui-loading {
				margin-top: 50px;
			}
			.mui-slider-progress-bar{
			    background:#EA4F16!important;
			}
			.mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active {
				color: #EA4F16!important;
				background: 0 0;
				border-bottom: 2px solid #007aff;
			}
		</style>
	  </head>
	  
	  <body> 	  	

		  
		 <header class="mui-bar mui-bar-nav">
			 <span class="mui-pull-right">
		            <span class="mui-icon iconfont icon-up" style="position: absolute;right:10px;top:6px;color:#cccccc;font-size:12px !important;"></span>								
  					<select class="mui-btn mui-btn-block mui-pull-right" style="width:20%;background: transparent;padding-right:20px;position: absolute;right: 0;" name="dateType" id="dateType">	
  					    <option value="0">今日</option>
  					    <option value="1">昨日</option>
  					    <option value="2">本周</option>
  					    <option value="3">上周</option>
  					    <option value="4">本月</option>
  					    <option value="5">上月</option>	
  					    <option value="6">自定义</option>							
					</select>	
		      </span>      
		     
		      
		      <span class="mui-pull-right">
		            <span class="mui-icon iconfont icon-up" style="position: absolute;right: 30%;top:6px;color:#cccccc;font-size:12px !important;"></span>								
  					<select class="mui-btn mui-btn-block mui-pull-right" style="width:40%;background: transparent;padding-right:20px;position: absolute;right: 20%;" name="storeType" id="storeType">	  					    
  					      					   							
					</select>	
		      </span>
		      
		       <span class="mui-pull-right">
		            <span class="mui-icon iconfont icon-up" style="position: absolute;right: 66%;top:6px;color:#cccccc;font-size:12px !important;"></span>								
  					<select class="mui-btn mui-btn-block mui-pull-right" style="width:30%;background: transparent;padding-right:20px;position: absolute;right: 66%;" name="searchType" id="searchType">	
  					    <option value="0" class="employee">员工打赏榜</option>
  					    <option value="1" class="employee">员工评价榜</option>
  					    <option value="2" class="manager">店长分成榜</option>
  					    <option value="3" class="orgnize">区长分成榜</option>
  					   								
					</select>	
		      </span>
		  </header> 
		 <div class="mui-content"  >
		    <div class="scroller">
		  		<a href="#resultpage" id="rega" style="display:none;"></a>
		  		<div class="plat-content mui-content">
		  			<!-- 显示查询日期 -->
		  			<div id="dateWindow-disTime" style="text-align: center;display:none;margin-top:5px;">
		  			   <span style="color:red;padding:0 30px;" id="disStartTime"></span>至 <span style="color:red;padding:0 30px;" id="disEndTime"></span>
		  			</div>
		  			<!-- template-page -->
		  			<div id="slider" class="mui-slider">
						<div id="sliderSegmentedControl" class="mui-segmented-control mui-segmented-control-inverted">
							<a class="mui-control-item mui-active" href="#item1mobile">
								打赏次数榜
							</a>
							<a class="mui-control-item" href="#item2mobile">
								打赏金额榜
							</a>								
						</div>
						<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-6"></div>
						<div class="mui-slider-group">
							<div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
								        <ul class="mui-table-view" id="template-page-content-my0">					
										</ul>
										<ul class="mui-table-view" id="template-page-content0" style="">					
										</ul>
									
							</div>
							<div id="item2mobile" class="mui-slider-item mui-control-content">								
									
											<ul class="mui-table-view" id="template-page-content-my1">					
											</ul>
											<ul class="mui-table-view" id="template-page-content1" style="">					
										    </ul>
																		
							</div>
							
						</div>
					</div>		
					
				  
				</div>
				<!-- 页面底部标题 -->
			</div>
		  </div>		
            
		</div>
		
		<!-- 弹出日期 -->
		<div  class="dateWindow" style="display:none;">
			<div style="width: 100%;position: absolute;top: 45px;background: white;z-index:99999;">
				<div class="mui-content-padded tips-reginfo-submit" style="margin: 30px 5%;">
					<input type="date" id="startTime" class="mui-input-clear date" placeholder="请选择时间"  style="border: 1px solid #EA4F16;text-align: center;width: 45%;margin-left: 3%;margin-right: 3%;">
					<input type="date" id="endTime" class="mui-input-clear date" placeholder="请选择时间" style="border: 1px solid #EA4F16;text-align: center;width: 45%;">
					<button type="button" class="mui-btn mui-btn-warning mui-btn-block customerDate" style="margin-top:10px;width: 94%;margin-left: 3%;">确定</button>
				</div>
			</div>
			<div style="width: 100%;height:100%;position: absolute;top: 45px;background: rgba(0,0,0,0.3);z-index:99998;">				
			</div>
		</div>
	  [#include '../model/menu.html']
	  </body>
	  <script src="${basepath}/assets/plugin/require.js"></script>
	  <script type="text/javascript" src="${basepath}/assets/def/js/tips/tips.js"></script>
	  <!-- 打赏列表模板 -->
	  <script type="text/template" id="template-tips-page">
			{{#each data}}
			<li class="mui-table-view-cell mui-media tips{{index}}" >
							<a data-id="{{employeeID}}" data-count={{rankCount}}>
								{{#js_compare "this.index < 4"}}
                                   <span class="mui-media-object mui-pull-left"><i class="mui-icon iconfont icon-order" style="font-size:30px !important;color:#EA4F16;"></i></span>
                                   <label class="em">{{index}}</label> 
                                {{else}}
                                    <span class="mui-media-object mui-pull-left"><i class="mui-icon iconfont icon-order" style="font-size:30px !important;color:#fff;"></i></span>
                                    <label class="em" style="color:#ccc;">{{index}}</label> 
								  
                                {{/js_compare}} 
								<span  class="mui-media-body" ><span style="font-size:15px;">{{empName}}<span style='font-size:13px;color:#ccc;'>({{storeName}})</span></span></span>
								<div style="float:right;font-size:14px;">
								    <span style="float:left;padding-right:10px;line-height:40px;">{{count}}次</span>
								    <span style="float:left;line-height:40px;color:#EA4F16;min-width:3.0em;">￥<label style="font-size:1.1em;font-weight:bold;">{{amountCount}}{{shopownerDivided}}</label></span>
								</div>	
							</a>
			 </li>
			{{/each}}
	  </script>
	  
	  <!-- 评价列表模板 -->
	  <script type="text/template" id="template-evaluate-page">
			{{#each data}}
			<li class="mui-table-view-cell mui-media evalute{{index}}" >
							<a data-id="{{employeeID}}"  data-count={{rankCount}}>								
								{{#js_compare "this.index < 4"}}
                                   <span class="mui-media-object mui-pull-left"><i class="mui-icon iconfont icon-order" style="font-size:30px !important;color:#EA4F16;"></i></span>
                                   <label class="em">{{index}}</label> 
                                {{else}}
                                    <span class="mui-media-object mui-pull-left"><i class="mui-icon iconfont icon-order" style="font-size:30px !important;color:#fff;"></i></span>
                                    <label class="em" style="color:#ccc;">{{index}}</label> 
								  
                                {{/js_compare}}
								<span  class="mui-media-body" ><span style="font-size:15px;">{{empName}}<span style='font-size:13px;color:#ccc;'>({{storeName}})</span></span></span>
								<div style="float:right;font-size:14px;">
								    <span style="float:left;padding-right:10px;line-height:40px;">{{count}}次</span>
								    <span style="float:left;">
								        <div style="text-align:left;color:#EA4F16;font-weight:bold;">{{score}}</div>
								        <div> 
									       <span class="intro-text">
                          					<span class="def-mui-icon ranklist evaluatelist-star{{employeeID}}" style="color:#cccccc;">
								               <i class="mui-icon iconfont icon-star" data-num=1></i>
								               <i class="mui-icon iconfont icon-star" data-num=2></i>
								               <i class="mui-icon iconfont icon-star" data-num=3></i>
								               <i class="mui-icon iconfont icon-star" data-num=4></i>
								               <i class="mui-icon iconfont icon-star" data-num=5></i>
						                    </span>
						                    <script>
                                                   Template7.global.tools.setStar({{score}}+"",jQuery(".evaluatelist-star{{employeeID}}").find(".icon-star"),"#F3D958");
                                            <\/script>
                                           </span> 	
										</div>
								    </span>
								</div>	
							</a>
			 </li>
			{{/each}}
	  </script>
  	 

  	  
  	  
	  <script type="text/javascript">
	  require(["jquery","mui","mui_view","template7","addr","common","ftscroller"],function($$,M,mui_view,template7,addr,tools){
		  Template7.global = {};
		  Template7.global.tools=tools;
  
		  $$(document).ready(function(){
			  if(window.localStorage.getItem("level")==2){
				  $$(".manager").remove();
				  $$("#storeType").append('<option value="0">所在店铺</option>');
			  }else if(window.localStorage.getItem("level")==1){
				  $$(".employee").remove();				  
				  addr.getStoreList('empId='+tools.global.empId, function(data){
					  if(data&&data.resultMessage.messageCode=="0000"){
						  var list = data.resultData.body.result;
						  var strHtml=["<option value='1'>全国店铺</option>"];
						  for(var i=0;i<list.length;i++){
							  
							  if(tools.global.storeId>0 ){
					  			  if(tools.global.storeId == list[i].storeId){
					  				 strHtml.push("<option value='"+list[i].storeId+"' selected='selected'  data-qrcode='"+list[i].qrcode+"'>"+list[i].storeName+"</option>");	
					  			  }
				  			  }else{
								  tools.global.storeId = list[0].storeId ; 
								  strHtml.push("<option value='"+list[i].storeId+"'  data-qrcode='"+list[i].qrcode+"'>"+list[i].storeName+"</option>");	
				  			  }
						  }						  
						  $$("#storeType").append(strHtml.join(""));
					  }
					  					 			  
					  //主页列表
					  loaddata();
					  
				  });
				  
			  }else{
				  addr.getStoreList('empId='+tools.global.empId, function(data){
					  if(data&&data.resultMessage.messageCode=="0000"){
						  var list = data.resultData.body.result;
						  var strHtml=["<option value='1'>全国店铺</option>"];
						  if(list.length==0){
							  strHtml.push('<option value="0">所在店铺</option>');
						  }
						  for(var i=0;i<list.length;i++){
							  tools.global.storeId = list[0].storeId ; 
							  strHtml.push("<option value='"+list[i].storeId+"'  data-qrcode='"+list[i].qrcode+"'>"+list[i].storeName+"</option>");		
						  }
						  
						  $$("#storeType").append(strHtml.join(""));
					  }					  
					 
					  
					 //主页列表
					 loaddata();
				  });
			  }
        	  
			  //加载是否有经理管理
		      addr.getJson(addr.mercants.findParentOrg,null,function(data){
					  if(data&&data.resultMessage.messageCode=="0000"){
						  var datas = data.resultData.body.result;	
						  if(datas.length<=0){
							  $$(".orgnize").remove();
						  }

					  }
			  });
        	  
			  //重置参数
			  var reset=function(){
				  $$("#template-page-content0").html("");
				  $$("#template-page-content1").html("");
				  $$("#template-page-content-my0").html("");
				  $$("#template-page-content-my1").html("");	
				  $$("#dateWindow").hide();
				  $$("#dateWindow-disTime").hide();
				  
				  pageNo=1;
				  loaddata();
			  }
			  
			  //日期切换
			  $$("#dateType").on("change",function(){
				  if($$(this).val()==6){
					  $$(".dateWindow").show();
					  return;
				  }
				  reset();
			  });
			  
			//点击日期重新选择时间
			  $$("#dateWindow-disTime").on("tap",function(){
				  mui.trigger(document.getElementById("dateType"),'change');
			  })
			  
			  //查询类型
			  $$("#searchType").on("change",function(){
				  if($$("#searchType").val()==3){
					  addr.getJson(addr.mercants.findParentOrg,null,function(data){
						  if(data&&data.resultMessage.messageCode=="0000"){
							  var datas = data.resultData.body.result;							  
							  var strHtml=[];						
							  for (var i = 0; i < datas.length; i++) {
									var da = datas[i];
									////记录所有的商户
									strHtml.push('<option value="' + da.orgCode + '" data-schema="'+da.schema+'">' + da.orgName+ '</option>');															
							  }
							   
							  $$("#storeType").html(strHtml.join(""));
							   
							  //加载数据
							  pageNo1=1;
							  reset();
						  }else{
							  $$("#storeType").html();
						  }
					  });
				  }else{
					  addr.getStoreList('empId='+tools.global.empId, function(data){
						  if(data&&data.resultMessage.messageCode=="0000"){
							  var list = data.resultData.body.result;
							  var strHtml=["<option value='1'>全国店铺</option>"];
							  for(var i=0;i<list.length;i++){
								  tools.global.storeId = list[0].storeId ; 
								  strHtml.push("<option value='"+list[i].storeId+"'  data-qrcode='"+list[i].qrcode+"'>"+list[i].storeName+"</option>");		
							  }
							  
							  $$("#storeType").html(strHtml.join(""));
						  }else{
							  $$("#storeType").html("<option value='1'>全国店铺</option>");
						  }					  
						 
						  
						 //加载数据
						  pageNo1=1;
						  reset();
						  
					  });
					  
				  }
				  
				 
				  
				  if($$("#searchType").val() == 1){
					  $$("#sliderSegmentedControl").find("a").eq(0).html("评价次数榜");
					  $$("#sliderSegmentedControl").find("a").eq(1).html("评价得分榜");
				  }else if ($$("#searchType").val() == 2 || $$("#searchType").val() == 3 ){
					  $$("#sliderSegmentedControl").find("a").eq(0).html("分成次数榜");
					  $$("#sliderSegmentedControl").find("a").eq(1).html("分成金额榜");
				  }else{
					  $$("#sliderSegmentedControl").find("a").eq(0).html("打赏次数榜");
					  $$("#sliderSegmentedControl").find("a").eq(1).html("打赏金额榜");
				  }
			  });
			  
			  //范围切换
			  $$("#storeType").on("change",function(){
				  pageNo1=1;
				  reset();
			  });
			  
			  //按日期查询
			  $$(".customerDate").on("click",function(){
				  reset();
				  $$(".dateWindow").hide();
			  })
        	  
			  //tab切换加载
			  var item2 = document.getElementById('item2mobile');
			  document.getElementById('slider').addEventListener('slide', function(e) {
				if (e.detail.slideNumber === 1) {
					type = 1;		
					reset();				
								
				}else{
					type = 0;		
					reset();
				
				} 
			  });
				

			  
		  });
		  
	  });
	  
	  //日期格式
	  var dateFormat = function(date){
		  try{
			  var year= date.substring(0,4);
			  var month=date.substring(5,7);
			  var day=date.substring(8,10);
			  return year+""+month+day;
		  }catch(e){return "";}
	  }
	  
	  //加载排行列表数据
	  var pageNo=1;
	  var pageNo1=1;
	  var type = 0;
	  var loaddata = function(){ 
		  var addr = require("addr");
		  var tools = require("common");
		  //查询本店还是全国
		  var storeType=0;
		  var storeId = tools.global.storeId ;
		  if(jQuery("#storeType").val()>1){
			  storeId = jQuery("#storeType").val() ; 
		  }else{
			  storeType = jQuery("#storeType").val(); 
		  }
		  
		  //判断是否显示日期
		  if(jQuery("#dateType").val()==6){
			  jQuery("#dateWindow-disTime").show();
			  jQuery("#disStartTime").html(jQuery("#startTime").val());
			  jQuery("#disEndTime").html(jQuery("#endTime").val());
		  }else{
			  jQuery("#dateWindow-disTime").hide();
		  }
		  
		  var json={"searchType":jQuery("#searchType").val(),"type":type,"dateType":jQuery("#dateType").val(),"storeId":storeId,"storeType":storeType,groupType:1,"numPerPage":"50","pageNum":"1","startTime":dateFormat(jQuery("#startTime").val()),"endTime":dateFormat(jQuery("#endTime").val()),orgCode:jQuery("#storeType").val()};
		  var loadbar=tools.loading();
		  window.setTimeout(function(){
			  loadbar.close();
		  }, 2000);
		  
// 		  if(type ==0 && pageNo>tools.global.totalPages){
// 			 return;
// 		  }
// 		  if(type ==1 && pageNo1>tools.global.totalPages1){
// 			 return;
// 		  }
		 
		  addr.findStorManagerRanking(JSON.stringify(json),function(data){
			  loadbar.close();
			  if(data!=null&&data.resultMessage.messageCode=="0000" &&
				  data.resultData.body.result!=null&&data.resultData.body.result.result.length!=0){
				  
				  if($("#searchType").val()==1){
					  var template = document.getElementById('template-evaluate-page').innerHTML;				  
					  var compiled = Template7(template).compile();
					  var arrData = data.resultData.body.result.result;
					  var curObj=0;
					  for(var i=0;i<arrData.length;i++){
						  arrData[i].index=(i+1);
						  if(arrData[i].empId == tools.global.empId){
							  curObj = arrData[i].index;
						  }
					  }
					  var compiledRendered = compiled({data:arrData});

					  jQuery("#template-page-content"+type).append(compiledRendered);
					   
					  if(curObj>0){
						  jQuery("#template-page-content-my"+type).html(jQuery("#template-page-content"+type).find(".evalute"+curObj).css("margin-bottom","10px"));
					  }else{
						  jQuery("#template-page-content-my"+type).html("<li style='margin-bottom:10px;'>你的排名太落后了，请继续加油哦！</li>"); 
					  }
					  
				  }else{
					  var template = document.getElementById('template-tips-page').innerHTML;				  
					  var compiled = Template7(template).compile();
					  var arrData = data.resultData.body.result.result;
					  var curObj=0;
					  for(var i=0;i<arrData.length;i++){
						  arrData[i].index=(i+1);
						  if(arrData[i].empId == tools.global.empId){
							  curObj = arrData[i].index;
						  }
					  }
					  var compiledRendered = compiled({data:arrData});

					  jQuery("#template-page-content"+type).append(compiledRendered); 
					  if(curObj>0){
					  	  jQuery("#template-page-content-my"+type).html(jQuery("#template-page-content"+type).find(".tips"+curObj).css("margin-bottom","10px"));
					  }else{
						  jQuery("#template-page-content-my"+type).html("<li style='margin-bottom:10px;'>你的排名太落后了，请继续加油哦！</li>"); 
					  }
				  }
				  
				  
				  if(type==0){
					  pageNo++;
					  tools.global.totalPages = data.resultData.body.result.totalPages;		
				  }else if (type == 1){
					  pageNo1++;
					  tools.global.totalPages1 = data.resultData.body.result.totalPages;		
				  }
			  }
			  
			 
			  
		  });
	  }
	  
	  

	  

	  </script>
</html>			