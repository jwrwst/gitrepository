<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.platform.rp.services.employee.core.dao.BsEmployeeExtEvaluateDAO">
    
    <resultMap type="com.platform.rp.services.employee.core.dao.entity.BsEmployeeExtEvaluateEntity" id="empExtEvaluateEntityMap">
        <id column="id" property="id" />
        <result column="emp_id" property="empId" />
		<result column="store_id" property="storeId" />
		<result column="day_count" property="dayCount" />
		<result column="yesterday_count" property="yesterdayCount" />
		<result column="week_count" property="weekCount" />
		<result column="lastweek_count" property="lastweekCount" />
		<result column="month_count" property="monthCount" />
		<result column="lastmonth_count" property="lastmonthCount" />
		<result column="total_count" property="totalCount" />
		<result column="day_score" property="dayScore" />
		<result column="yesterday_score" property="yesterdayScore" />
		<result column="week_score" property="weekScore" />
		<result column="lastweek_score" property="lastweekScore" />
		<result column="month_score" property="monthScore" />
		<result column="lastmonth_score" property="lastmonthScore" />
		<result column="total_score" property="totalScore" />
		<result column="status" property="status" />
		<result column="update_time" property="updateTime" />
	</resultMap>
    
    <resultMap type="com.platform.rp.services.store.external.vo.StoreRankVo" id="storeRankVoMap">
        <result column="count" property="rankCount" />
		<result column="score" property="rankData" />
		<result column="empnickname" property="empNickname" />
		<result column="empId" property="employeeID" />
		<result column="empname" property="empName" />
		<result column="updatetime" property="updateTime" />
		<result column="altercount" property="alterRankCount" />
		<result column="alterdata" property="alterRankData" />
	</resultMap>
	
    <resultMap type="com.platform.rp.services.store.external.vo.StoreDynamicInfoVo" id="storeDynamicInfoVoMap">
        <result column="daycount" property="dayCount" />
		<result column="yesterdaycount" property="yesterdayCount" />
		<result column="avgday" property="dayData" />
		<result column="avgyesterday" property="yesterdayData" />
	</resultMap>
	
    <resultMap type="com.platform.rp.services.employee.external.vo.EmployeeRankDetailVo" id="employeeRankDetailVoMap">
        <result column="dayscore" property="dayData" />
		<result column="weekscore" property="weekData" />
		<result column="monthscore" property="monthData" />
		<result column="empnickname" property="empNickname" />
		<result column="jobnumber" property="jobNumber" />
		<result column="updatetime" property="updateTime" />
	</resultMap>
	
    <resultMap type="com.platform.rp.services.employee.external.vo.EmployeeIncomeBaseInfoVo" id="employeeIncomeBaseInfoVoMap">
        <result column="count" property="evaluateCount" />
		<result column="avgscore" property="avgEvaluateScore" />
	</resultMap>
	
    <insert id="save" useGeneratedKeys="true" keyProperty="id" parameterType="com.platform.rp.services.employee.core.dao.entity.BsEmployeeExtEvaluateEntity">
		insert into bs_employee_ext_evaluate(emp_id,store_id,day_count,yesterday_count,week_count,lastweek_count,month_count,lastmonth_count,total_count,day_score,yesterday_score,week_score,lastweek_score,month_score,lastmonth_score,total_score,status,update_time)
		values(#{empId},#{storeId},#{dayCount},#{yesterdayCount},#{weekCount},#{lastweekCount},#{monthCount},#{lastmonthCount},#{totalCount},#{dayScore},#{yesterdayScore},#{weekScore},#{lastweekScore},#{monthScore},#{lastmonthScore},#{totalScore},#{status},#{updateTime})
	</insert>
	
    <update id="update" parameterType="com.platform.rp.services.employee.core.dao.entity.BsEmployeeExtEvaluateEntity">
		update bs_employee_ext_evaluate
		<set>
			<if test="dayCount != null"> day_count = #{dayCount}, </if>
			<if test="yesterdayCount != null"> yesterday_count = #{yesterdayCount}, </if>
			<if test="weekCount != null"> week_count = #{weekCount}, </if>
			<if test="lastweekCount != null"> lastweek_count = #{lastweekCount}, </if>
			<if test="monthCount != null"> month_count = #{monthCount}, </if>
			<if test="lastmonthCount != null"> lastmonth_count = #{lastmonthCount}, </if>
			<if test="totalCount != null"> total_count = #{totalCount}, </if>
			<if test="dayScore != null"> day_score = #{dayScore}, </if>
			<if test="yesterdayScore != null"> yesterday_score = #{yesterdayScore}, </if>
			<if test="weekScore != null"> week_score = #{weekScore}, </if>
			<if test="lastweekScore != null"> lastweek_score = #{lastweekScore}, </if>
			<if test="monthScore != null"> month_score = #{monthScore}, </if>
			<if test="lastmonthScore != null"> lastmonth_score = #{lastmonthScore}, </if>
			<if test="totalScore != null"> total_score = #{totalScore}, </if>
			<if test="status != null"> status = #{status}, </if>
			<if test="updateTime != null and updateTime != ''"> update_time = #{updateTime}, </if>
		</set>
		<where>
		    emp_id = #{empId}
		    <if test="storeId != null"> and store_id = #{storeId}</if>
		</where>
	</update>
	
    <select id="count" resultType="int" parameterType="map">
		select count(1) from bs_employee_ext_evaluate  
		<where>
		    1 = 1
		    <if test = "storeId != 0 and storeId != null"> and store_id = #{storeId}</if>
		    <if test = "empId != 0 and empId != null"> and emp_id = #{empId}</if>
		    <if test = "filter == 'day'">
		        <if test = "startDay != null and endDay != null"> and update_time &gt;= #{startDay} and update_time &lt;= #{endDay}</if>
		    </if>
		    <if test = "filter == 'yesterday'">
		        <if test = "startDay != null and endDay != null and startYesterday != null and endYesterday != null"> and ((update_time &gt;= #{startDay} and update_time &lt;= #{endDay}) or (update_time &gt;= #{startYesterday} and update_time &lt;= #{endYesterday}))</if>
		    </if>
		    <if test = "filter == 'week'">
		        <if test = "startWeek != null and endWeek != null"> and update_time &gt;= #{startWeek} and update_time &lt;= #{endWeek}</if>
		    </if>
		    <if test = "filter == 'lastweek'">
		        <if test = "startWeek != null and endWeek != null and startLastWeek != null and endLastWeek != null"> and ((update_time &gt;= #{startWeek} and update_time &lt;= #{endWeek}) or (update_time &gt;= #{startLastWeek} and update_time &lt;= #{endLastWeek}))</if>
		    </if>
		    <if test = "filter == 'month'">
		        <if test = "startMonth != null and endMonth != null"> and update_time &gt;= #{startMonth} and update_time &lt;= #{endMonth}</if>
		    </if>
		    <if test = "filter == 'lastmonth'">
		        <if test = "startMonth != null and endMonth != null and startLastMonth != null and endLastMonth != null"> and ((update_time &gt;= #{startMonth} and update_time &lt;= #{endMonth}) or (update_time &gt;= #{startLastMonth} and update_time &lt;= #{endLastMonth}))</if>
		    </if>
		</where> 
	</select>
	
    <sql id="page">
		<if test="start > -1">
			<if test="pageSize > 0">
				limit #{start}, #{pageSize}
			</if>
			<if test="pageSize == 0 or pageSize == '' or pageSize &lt; 0">
				limit #{start}
			</if>
		</if>
	</sql>
	
    <select id="getPage" resultMap="storeRankVoMap" parameterType="map">
		<if test = "filter == 'day'">
		    Select a.update_time as updateTime, a.day_count as count, a.day_score as score, b.nickname as empnickname, b.name as empname, b.emp_id as empId 
		    from bs_employee_ext_evaluate a left join bs_employee_info b 
		    on b.emp_id = a.emp_id
			<where>
			    1 = 1
			    <if test = "storeId != 0 and storeId != null"> and a.store_id = #{storeId}</if>
		    	<if test = "empId != 0 and empId != null"> and a.emp_id = #{empId}</if>
		    	<if test = "startDay != null and endDay != null"> and a.update_time &gt;= #{startDay} and a.update_time &lt;= #{endDay}</if>
			</where>
			order by a.update_time desc
        </if>
        <if test = "filter == 'yesterday'">
            Select a.update_time as updateTime, a.yesterday_count as count, a.yesterday_score as score, a.day_count as altercount, a.day_score as alterdata, b.nickname as empnickname, b.name as empname, b.emp_id as empId 
			from bs_employee_ext_evaluate a left join bs_employee_info b
			on b.emp_id = a.emp_id
			<where>
			    1 = 1
			    <if test = "storeId != 0 and storeId != null"> and a.store_id = #{storeId}</if>
		    	<if test = "empId != 0 and empId != null"> and a.emp_id = #{empId}</if>
		    	<if test = "startDay != null and endDay != null and startYesterday != null and endYesterday != null"> and ((a.update_time &gt;= #{startDay} and a.update_time &lt;= #{endDay}) or (a.update_time &gt;= #{startYesterday} and a.update_time &lt;= #{endYesterday}))</if>
			</where> 
			order by a.update_time desc
        </if>
        <if test = "filter == 'week'">
            Select a.update_time as updateTime, a.week_count as count, a.week_score as score, b.nickname as empnickname, b.name as empname, b.emp_id as empId 
			from bs_employee_ext_evaluate a left join bs_employee_info b
			on b.emp_id = a.emp_id
			<where>
			    1 = 1
			    <if test = "storeId != 0 and storeId != null"> and a.store_id = #{storeId}</if>
		    	<if test = "empId != 0 and empId != null"> and a.emp_id = #{empId}</if>
		    	<if test = "startWeek != null and endWeek != null"> and a.update_time &gt;= #{startWeek} and a.update_time &lt;= #{endWeek}</if>
			</where>
			order by a.update_time desc
        </if>
        <if test = "filter == 'lastweek'">
            Select a.update_time as updateTime, a.lastweek_count as count, a.lastweek_score as score, a.week_count as altercount, a.week_score as alterdata, b.nickname as empnickname, b.name as empname, b.emp_id as empId 
			from bs_employee_ext_evaluate a left join bs_employee_info b
			on b.emp_id = a.emp_id
			<where>
			    1 = 1
			    <if test = "storeId != 0 and storeId != null"> and a.store_id = #{storeId}</if>
		    	<if test = "empId != 0 and empId != null"> and a.emp_id = #{empId}</if>
		    	<if test = "startWeek != null and endWeek != null and startLastWeek != null and endLastWeek != null"> and ((a.update_time &gt;= #{startWeek} and a.update_time &lt;= #{endWeek}) or (a.update_time &gt;= #{startLastWeek} and a.update_time &lt;= #{endLastWeek}))</if>
			</where>
			order by a.update_time desc
        </if>
        <if test = "filter == 'month'">
            Select a.update_time as updateTime, a.month_count as count, a.month_score as score, b.nickname as empnickname, b.name as empname, b.emp_id as empId 
			from bs_employee_ext_evaluate a left join bs_employee_info b
			on b.emp_id = a.emp_id
			<where>
			    1 = 1
			    <if test = "storeId != 0 and storeId != null"> and a.store_id = #{storeId}</if>
		    	<if test = "empId != 0 and empId != null"> and a.emp_id = #{empId}</if>
		    	<if test = "startMonth != null and endMonth != null"> and a.update_time &gt;= #{startMonth} and a.update_time &lt;= #{endMonth}</if>
			</where>
			order by a.update_time desc
        </if>
        <if test = "filter == 'lastmonth'">
            Select a.update_time as updateTime, a.lastmonth_count as count, a.lastmonth_score as score, a.month_count as altercount, a.month_score as alterdata, b.nickname as empnickname, b.name as empname, b.emp_id as empId  
			from bs_employee_ext_evaluate a left join bs_employee_info b
			on b.emp_id = a.emp_id
			<where>
			    1 = 1
			    <if test = "storeId != 0 and storeId != null"> and a.store_id = #{storeId}</if>
		    	<if test = "empId != 0 and empId != null"> and a.emp_id = #{empId}</if>
		    	<if test = "startMonth != null and endMonth != null and startLastMonth != null and endLastMonth != null"> and ((a.update_time &gt;= #{startMonth} and a.update_time &lt;= #{endMonth}) or (a.update_time &gt;= #{startLastMonth} and a.update_time &lt;= #{endLastMonth}))</if>
			</where>
			order by a.update_time desc
        </if>
		<include refid="page" />
	</select> 
	
    <select id="getStoreDayDynamicByStoreId" resultMap="storeDynamicInfoVoMap" parameterType="long">
		Select sum(day_count) as daycount, sum(yesterday_count) as yesterdaycount, cast(avg(day_score) as decimal(10,2)) as avgday, cast(avg(yesterday_score) as decimal(10,2)) as avgyesterday
		from bs_employee_ext_evaluate
		where store_id = #{storeId} and  update_time &gt;= #{startDay} and update_time &lt;= #{endDay}
	</select>
	
    <select id="getStoreYesterdayDynamicByStoreId" resultMap="storeDynamicInfoVoMap" parameterType="long">
		Select sum(day_count) as daycount, sum(yesterday_count) as yesterdaycount, cast(avg(day_score) as decimal(10,2)) as avgday, cast(avg(yesterday_score) as decimal(10,2)) as avgyesterday
		from bs_employee_ext_evaluate
		where store_id = #{storeId} and update_time &gt;= #{startYesterday} and update_time &lt;= #{endYesterday}
	</select>
	
    <select id="getEmployeeEvaluateRankDetail" resultMap="employeeRankDetailVoMap">
		Select a.day_score as dayscore, a.week_score as weekscore, a.month_score as monthscore, a.update_time as updatetime, b.nickname as empnickname, b.job_number as jobnumber
		from bs_employee_ext_evaluate a, bs_employee_info b 
		<where>
			a.store_id = #{storeId} and a.emp_id = #{empId} and b.emp_id = a.emp_id
		   	<if test = "startMonth != null and endMonth != null"> and update_time &gt;= #{startMonth} and update_time &lt;= #{endMonth}</if>
		</where>
	</select>
	
    <select id="getEmployeeEvaluate" resultMap="empExtEvaluateEntityMap">
		select * from bs_employee_ext_evaluate 
		<where>
		    emp_id = #{empId}
		    <if test="storeId != 0 and storeId != null"> and store_id = #{storeId}</if>
		</where>
	</select>
	
    <select id="getEmployeeIncomeBaseInfo" resultMap="employeeIncomeBaseInfoVoMap" parameterType="long">
		Select count(1) as count, (sum(total_score) / count(1)) as avgscore
		from bs_employee_ext_evaluate
		where emp_id = #{empId}
	</select>
</mapper>